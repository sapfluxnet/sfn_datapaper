---
title: "Figures for SAPFLUXNET data paper"
author: "R. Poyatos"
date: "27/12/2019"
output:
  word_document: 
    reference_docx: word-styles-reference-01.docx
  html_document:
    df_print: paged
  pdf_document: 
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sapfluxnetr)
library(purrr)
library(flextable)
library(pander)
library(magrittr)
library(ggplot2)
library(ggalluvial)
library(ggrepel)
library(ggbiome)
library(cowplot)
library(ggspatial)
library(raster)
library(VennDiagram)

source('R/sfn_datapaper_functions.R')
source('metadata_wrangling.R')
load('maps_base.RData')

```

## Figures

### Figure 1. Data workflow

### Figure 2. Geographic, bioclimatic and veg type coverage
- a) world map, b) biome plot, c) pft distribution
- TODO: world map is also shown in fig 3. Maybe go back to original idea of showing first 
the geographical distribution (now fig 3), then in another figure show biome and pft distribution.

### Figure 3. Detailed geographic distribution.
- The idea of this was to get rid of the global map, so it would not repeat somehow fig. 2. See comment
on fig. 2 ...

### Figure 4. Taxonomy.
- Major improvements by Víctor

### Figure 5. Sap flow methods and measurement level.

### Table 1. Calibrations

### Table 2. Whole-plant integration of sap flow data.

### Figure 6. Site and plant level attributes
- TODO: add titles to labels a) stand, b) plant, gymno/angio.

### Figure 7. Datasets duration and period
- Major improvements by Víctor

### Figure 8. Temporal patterns
- TODO: add titles to labels: a) ESP_CAN, Mediterranean, b), c

### Figure 9. Environmental variables

### Figure 10. Scaling.

\pagebreak

```{r data_workflow, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
knitr::include_graphics('resources/QC_process.svg')
```

Figure 1. Data workflow.

\pagebreak

```{r sitesmap, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=15, fig.width=15}
sitesmap_global <- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  guides(fill='none')+xlab(NULL)+ylab(NULL)+
  theme_light()+
  theme(axis.title=element_text(size=18),axis.text=element_text(size=18))

# TODO: preliminary filtering out climatic NAs
# Use CHELSA to gf 

biomes_plot <- sfn_allsites %>%
  dplyr::arrange(si_biome) %>%
  dplyr::filter(!is.na(si_map) | !is.na(si_map)) %>% 
  ggbiome::vis_location_biome(si_lat='si_lat',
                              si_long='si_long',si_mat='si_mat',si_map='si_map') +
  
  theme(
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    title= element_text(size=20),
    axis.title=element_text(size=20),
    axis.text=element_text(size=20),
    legend.title = element_blank(),
    legend.text = element_text(size =16),
    legend.key.size = unit(1.5, 'line'),
    legend.position = c(0.7,0.2)
    
  )

igbp_plot<-sfn_allsites %>% 
  group_by(si_igbp) %>% 
  tally() %>% 
  ggplot(.,aes(y=n,x=reorder(si_igbp,desc(n))))+
  geom_bar(stat='identity')+
  xlab('Vegetation type')+ylab('Number of datasets')+
  theme_light()+
  theme(axis.title=element_text(size=18),axis.text=element_text(size=18))

# Build figure 
cowplot::plot_grid(
  # row 1
  cowplot::plot_grid(sitesmap_global, labels='(a)'),
  # row 2
  cowplot::plot_grid(biomes_plot, igbp_plot,labels=c('(b)','(c)'),rel_widths=c(0.6,0.4)),
  ncol=1, label_size=16, rel_heights=c(0.6,0.4))

```

Figure 2. Geographical distribution of SAPFLUXNET datasets.

\pagebreak


```{r regional_maps,fig.height=18, fig.width=15, cache=TRUE,echo=FALSE, message=FALSE, warning=FALSE,}

# a) Site labels 

# b) Select countries to plot 

countries_sfn <- unique(sapply(strsplit(sfn_allsites$si_code,"_"),"[[",1))
countries_label <- c('ARG','BRA','COL','CRI','CHN','GUF','IDN','ISR','KOR','MDG','MEX','NZL','RUS','SEN','THA','UZB')
countries_europe <- c('AUT','CHE','CZE','DEU','ESP','FIN','FRA','GBR','HUN','ITA','NLD','PRT','SWE')
countries_america <- c('CAN','USA')
countries_austral <- c('AUS')
countries_africa <- c('MDG','ZAF')


# c) Add numeric codes 

sfn_allsites_country<- sfn_allsites %>% 
  mutate(country=sapply(strsplit(si_code,"_"),"[[",1),
         num_code = as.integer(factor(si_code)))


# 3. Map, numeric codes, ggrepel not aligned ------------------------------------------------------

# world
sfnsites_world_dr <- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_label), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_x = -0.35,direction = "both",
                  box.padding = unit(0.1, 'lines'), force = 0.5)+geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# europe
sfnsites_europe_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_europe), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_y = -0.35,direction = "both",
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(-20, 40), ylim = c(32, 67), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# america
sfnsites_america_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_america), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_x = -0.35,direction = "both",
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(-130, -60), ylim = c(30, 55), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# austral
sfnsites_austral_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_austral), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_x = -0.35,
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(110, 162), ylim = c(-10, -50), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# africa
sfnsites_africa_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_africa), aes(si_long, si_lat, label = num_code), size = 3,
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(10, 50), ylim = c(-10, -40), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)



# e) Build figure 

plot_grid(
  plot_grid(sfnsites_world_dr,ncol=1,nrow=1,labels=c('a)')),
  plot_grid(sfnsites_europe_dr,sfnsites_austral_dr,ncol=2,nrow=1,rel_widths=c(1,0.7),labels=c('b)','c)')),
  plot_grid(sfnsites_america_dr,sfnsites_africa_dr,ncol=2,nrow=1,rel_widths=c(1,0.7),labels=c('d)','e)')),
  nrow=3,rel_heights=c(1,1,0.7))

```
Figure 3. Detailed geographic distribution.

\pagebreak

```{r genera_species,fig.height=15, fig.width=12, echo=FALSE}

sfn_sitespecies_tax %>%
  group_by(genus,si_code) %>%
  summarise(n_si = sum(sp_ntrees)) %>% 
  group_by(genus) %>% 
  mutate(
    n_all = sum(n_si),
    vjust = n_si/sum(n_si),
    fill_dummy = if_else(n_si > 14, si_code, 'zz_other')
  ) %>%
  filter(n_all>50) %>%
  arrange(desc(n_si)) %>%
  mutate(
    accumulated = cumsum(n_si),
    segment_start = accumulated - (n_si/2)
  ) -> ntrees_species_top_data

ntrees_species_top_data %>%
  # only show label for those sites in each genus with 15 trees or more
  filter(n_si > 14) -> ntrees_species_top_data_labels

number_sites_labels <-
  ntrees_species_top_data %>%
  count() %>%
  mutate(x_label = paste0(n, ' sites'), y = 800) %>%
  left_join(
    ntrees_species_top_data %>%
      dplyr::select(genus, n_all) %>%
      distinct()
  )

ntrees_species_top <-
  ntrees_species_top_data %>% 
  ggplot(aes(x = reorder(genus, n_all), y = n_si, fill = reorder(fill_dummy, n_si))) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  geom_text(
    aes(label = x_label, y = y, x = reorder(genus, n_all)),
    data = number_sites_labels, inherit.aes = FALSE
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Pinus'),
    # position = 'identity',
    size = 2,
    # repel options
    nudge_x = 2.2,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Quercus'),
    # position = 'identity',
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 320 + ntrees_species_top_data_labels %>% filter(genus == 'Quercus') %>% pull(segment_start),
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Acer'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 190,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Picea'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 420,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Eucalyptus'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 210,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Fagus'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 280,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Populus'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 100,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Abies'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 60,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Acacia'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  scale_fill_manual(values = c('grey', viridis::viridis(30))) +
  scale_y_continuous(expand = expand_scale(c(0,0), c(0,100))) +
  scale_x_discrete(expand = expand_scale(c(0,0), c(1,2.5))) +
  # viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of trees',
       title = 'Genera with > 50 trees') +
  # coord_flip() +
  theme_bw() +
  theme(
    title= element_text(size = 14),
    axis.title=element_text(size = 14),
    axis.text=element_text(size = 14),
    axis.text.x=element_text(face='italic', angle = 30, vjust = 0.9, hjust = 0.8),
    legend.title = element_blank(),
    legend.position = 'none'
  )

# species plot
sfn_sitespecies_tax%>%
  filter(!is.na(sp_ntrees)) %>% 
  group_by(sp_name, si_code) %>%
  summarise(n = sum(sp_ntrees)) %>%
  group_by(sp_name) %>% 
  mutate(
    n_all=sum(n),
    vjust = n/sum(n),
    fill_dummy = if_else(n > 14, si_code, 'zz_other')
  ) %>% 
  filter(n_all>50) %>%
  arrange(desc(n)) %>%
  mutate(
    accumulated = cumsum(n),
    segment_start = accumulated - (n/2)
  ) -> ntrees_genus_top_data

ntrees_genus_top_data %>%
  # only show label for those sites in each genus with 15 trees or more
  filter(n > 14) -> ntrees_genus_top_data_labels

number_sites_labels_genus <-
  ntrees_genus_top_data %>%
  count() %>%
  mutate(x_label = paste0(n, ' sites'), y = 330) %>%
  left_join(
    ntrees_genus_top_data %>%
      dplyr::select(sp_name, n_all) %>%
      distinct()
  )

ntrees_genus_top <- 
  ntrees_genus_top_data %>% 
  ggplot(aes(x = reorder(sp_name, n_all), y = n, fill = reorder(fill_dummy, n))) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  geom_text(
    aes(label = x_label, y = y, x = reorder(sp_name, n_all)),
    data = number_sites_labels_genus, inherit.aes = FALSE
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus sylvestris'),
    size = 2,
    # repel options
    nudge_x = 2.2,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Picea abies'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 190,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Acer saccharum'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = c(125, 50),
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus taeda'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Populus tremuloides'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus koraiensis'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = c(140, 100, 60),
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus strobus'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Acer rubrum'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 60,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  scale_fill_manual(values = c('grey', viridis::viridis(19))) +
  scale_y_continuous(expand = expand_scale(c(0,0), c(0,50))) +
  scale_x_discrete(expand = expand_scale(c(0,0), c(1,2.5))) +
  # viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of trees', 
       title = 'Species with >50 trees') +
  # coord_flip() +
  theme_bw() +
  theme(
    title= element_text(size = 14),
    axis.title=element_text(size = 14),
    axis.text=element_text(size = 14),
    axis.text.x=element_text(face='italic', angle = 30, vjust = 0.9, hjust = 0.8),
    legend.title = element_blank(),
    legend.position = 'none'
  )

cowplot::plot_grid(ntrees_genus_top,ntrees_species_top,
                   label_size= 14,labels=c('a)', 'b)'),ncol=1, nrow=2, align = "v", axis = "b")
```
Figure 4. Taxonomic distribution of genera and species in SAPFLUXNET, showing (a) genera with > 50 trees and (b) species with > 30 trees in the database.

\pagebreak

```{r method_type,fig.height=18, fig.width=15, echo=FALSE}

ggplot(sfn_plants_type,
       aes(y = n, axis2 = pl_sens_meth, axis3= typef,axis1=group)) +
  geom_alluvium(aes(fill = group), width = 1/12)+
  geom_stratum(width = 1/12, alpha = .5) +
  geom_label_repel(stat = "stratum", infer.label = TRUE) +
  scale_x_discrete(limits = c("Group","Sap flow method", "Measurement level"), 
                   expand = c(.05, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1")+
  scale_fill_viridis_d()+
  ylab('Number of trees')+
  theme_minimal()+
  theme(legend.position = "none", axis.title=element_text(size=16),
        axis.text = element_text(size=16))
  
```

Figure 5. Distribution of trees in SAPFLUXNET according to sap flow method and measurement level.

\pagebreak


```{r table_calib, echo=FALSE}
sfn_allplants_tax %>% 
  group_by(pl_sens_meth) %>% 
  summarise(
    n_cal=sum(pl_sens_calib,na.rm=TRUE),
    n_noncal=sum(!pl_sens_calib,na.rm=TRUE),
    n_notprov=sum(is.na(pl_sens_calib),na.rm=TRUE),
    perc_calib = round(n_cal/(n_noncal+n_notprov)*100,1)) %>% 
  flextable() %>% 
  set_header_labels(
    pl_sens_meth='Method',
    n_cal='Calibrated',
    n_noncal='Non-calibrated',
    n_notprov='Not provided',
    perc_calib='% calibrated'
  ) %>% 
   set_caption('Table 1. Number of sap flow times series in SAPFLUXNET with species-specific calibrated data') %>% 
  autofit()

```

\pagebreak

```{r spatial_integration, echo=FALSE}

# Spatial integration of sap flow
left_join(
  #table  1 calibrations
  sfn_allplants_tax %>% 
    group_by(pl_sens_meth,pl_radial_int) %>% 
    tally()  %>% 
    pivot_wider(names_from='pl_radial_int',
                values_from='n',
                values_fill=list(n=0)) %>% 
    rename('Not provided'='NA'), # next table
 #table 2 integration
 sfn_allplants_tax %>% 
   group_by(pl_sens_meth,pl_azimut_int) %>% 
   tally()  %>% 
   pivot_wider(names_from='pl_azimut_int',
               values_from='n',
               values_fill=list(n=0)),
 by='pl_sens_meth') %>% 
  rename('Method' ='pl_sens_meth','N.provided'='NA') %>% 
  flextable(col_keys=c(
    'Method','Measured','Sensor-integrated','Corrected, measured radial variation',
    'No radial correction','Not provided',
     'measured','sensor_integrated','Corrected, measured azimuthal variation',
    'No azimuthal correction','N.provided')) %>% 
  set_header_labels(
    'measured'='Measured',
    'sensor_integrated'='Sensor-integrated',
    'N.provided'='Not provided'
  ) %>% 
  add_header_row(values=c('','Radial correction','Azimuthal correction'),colwidths=c(1,5,5)) %>% 
  align(i=1:8,align='right') %>% 
  bold(i=1,part='header') %>% 
  fontsize(size=10) %>% 
    fontsize(size=10,part='header') %>% 
  height(i=2,height=1,part='header') %>% 
  width(j=1,width=0.65) %>% 
  width(j=2:11,width=0.75) %>% 
  empty_blanks() %>% 
   set_caption('Table 2. Number of trees using different radial and azimuthal integration approaches, for 
               the different sap flow methods')



```



\pagebreak

```{r stand_plant_attributes, echo=FALSE, message=FALSE, warning=FALSE, fig.height=15, fig.width=18}

##########################################################################################
#
# Split violin plot code taken from here:
# https://stackoverflow.com/questions/35717353/split-violin-plot-with-ggplot2
#
GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, 
                           draw_group = function(self, data, ..., draw_quantiles = NULL) {
  data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
  grp <- data[1, "group"]
  newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
  newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
  newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])

  if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
    stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <=
      1))
    quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
    aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
    aesthetics$alpha <- rep(1, nrow(quantiles))
    both <- cbind(quantiles, aesthetics)
    quantile_grob <- GeomPath$draw_panel(both, ...)
    ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
  }
  else {
    ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
  }
})

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, 
        position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}
##########################################################################################

# Stand attributes --------------------------------------------------------

sfn_allstands_long <- 
  sfn_allstands %>%
  dplyr::select(
    si_code, st_age, st_height, st_density, st_basal_area, st_lai, st_soil_depth
  ) %>%
  pivot_longer(names_to = "Var", values_to = "Value", cols=st_age:st_soil_depth) %>%
  mutate(
    Varf = forcats::as_factor(Var) %>% forcats::fct_relabel(
      ~ c(
        'Age~(years)','Height~(m)','Stem~density~(stems~ha^{"-1"})',
        'Basal~area~(m^2~ha^{"-1"})','LAI~(m^2~m^{"-2"})','Soil~depth~(m)'
      )
    )
  )

stand_violins <-
  sfn_allstands_long %>% 
  ggplot(.,aes(x = Var, y = Value)) +
  geom_violin(fill = viridis::viridis(1, begin = 0.5), alpha = 0.3) +
  geom_point(colour = viridis::viridis(1, begin = 0.5),alpha = 0.5,
             position = position_jitter(width = 0.2, height = 0)) +
  facet_wrap(~Varf,scales = 'free', labeller = label_parsed) +
  guides(fill = FALSE) +
  labs(x = NULL, y = NULL) +
  theme_light() +
  theme(axis.text.x = element_blank(),axis.text.y = element_text(size = 16),
        strip.background = element_rect(fill = 'white', colour = 'darkgray'),
        strip.text = element_text(size = 16, colour = 'black', face = 'bold'))

#  Plant attributes -------------------------------------------------------

sfn_allplants_long <-
  sfn_allplants_tax %>%
  dplyr::select(
    pl_code, pl_dbh, pl_height, pl_sapw_area, pl_sapw_depth, pl_leaf_area, group
  ) %>% 
  pivot_longer(names_to = "Var", values_to = "Value", cols = pl_dbh:pl_leaf_area) %>% 
  mutate(
    Varf = forcats::as_factor(Var) %>% forcats::fct_relabel(
      ~ c(
        'DBH~(cm)', 'Height~(m)', 'Sapwood~area~(cm^2)',
        'Sapwood~depth~(cm)', 'Leaf~area(m^2)'
      )
    ),
  )


plant_violins <-
  sfn_allplants_long %>% 
  ggplot(aes(x = Var, y = Value, fill = group)) +
  geom_split_violin(alpha = 0.5) +
  # data points angios
  geom_point(
    aes(x = 0.75),
    data = sfn_allplants_long %>%
      filter(group == 'Angiosperms'),
    colour = viridis::viridis(1), alpha=0.2,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # median point angios
  geom_errorbarh(
    data = sfn_allplants_long %>%
        filter(group == 'Angiosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(xmin = 0.95, xmax = 1.05, y = median, fill = NA, height = 0),
    colour = 'white', size = 0.8,
    position = position_nudge(x = -0.03)
  ) +
  geom_point(
    data = sfn_allplants_long %>%
        filter(group == 'Angiosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = Var, y = median),
    colour = 'white', size = 3, shape = 23, fill = viridis::viridis(1),
    position = position_nudge(x = -0.03)
  ) +
  # data points gymnos
  geom_point(
    aes(x = 1.25),
    data = sfn_allplants_long %>%
      filter(group == 'Gymnosperms'),
    colour = viridis::viridis(1, direction = -1), alpha=0.2,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # median point gymnos
  geom_errorbarh(
    data = sfn_allplants_long %>%
        filter(group == 'Gymnosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(xmin = 0.95, xmax = 1.05, y = median, fill = NA, height = 0),
    colour = 'black', size = 0.8,
    position = position_nudge(x = 0.03)
  ) +
  geom_point(
    data = sfn_allplants_long %>%
        filter(group == 'Gymnosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = Var, y = median),
    colour = 'black', size = 3,
    shape = 23, fill = viridis::viridis(1, direction = -1),
    position = position_nudge(x = 0.03)
  ) +
  facet_wrap(~Varf,scales='free',labeller=label_parsed) +
  scale_fill_viridis_d() +
  labs(x=NULL,y=NULL)+
  theme_light() +
  guides(fill = guide_legend(title = 'Functional group')) +
  theme(
    axis.text.x = element_blank(), axis.text.y = element_text(size = 16),
    strip.background = element_rect(fill = 'white', colour='darkgray'),
    strip.text = element_text(size = 16, colour = 'black', face = 'bold'),
    legend.position = c(0.85, 0.25), legend.text = element_text(size = 14),
    legend.title = element_text(size = 15, face = 'bold')
  )

cowplot::plot_grid(
  NULL, plant_violins, NULL, stand_violins,
  labels = c('(a) Plant attributes', NA,  '(b) Stand attributes', NA),
  rel_widths = c(1,1,1,1), nrow = 4, rel_heights = c(0.1, 1, 0.1, 1),
  label_size = 16
)

```


Figure 6. Plant and stand attributes

```{r attributes_text, include=FALSE}

sfn_allplants_tax %>% 
  dplyr::select(pl_dbh,pl_height,pl_age,pl_sapw_area,pl_sapw_depth) %>% 
 map_df(~sum(is.na(.))/length(.)*100)


sfn_allplants_tax %>% 
  mutate(rank_dbh = dense_rank(desc(pl_dbh)),
         rank_sapw_area =dense_rank(desc(pl_sapw_area)),
         rank_sap_depth=dense_rank(desc(pl_sapw_depth)),
         rank_leaf_area=dense_rank(desc(pl_leaf_area))) %>% 
  arrange(rank_sapw_area) %>% 
  dplyr::select(si_code,pl_species,pl_dbh,pl_sapw_area,pl_sapw_depth,starts_with('rank')) %>% View()
  

sfn_allstands  %>% 
  dplyr::select(si_code,st_lai,st_density,st_basal_area,st_height,st_soil_depth) %>% 
 map_df(~sum(is.na(.))/length(.)*100)


sfn_allstands %>% 
  mutate(
    rank_lai= dense_rank(desc(st_lai)),
    rank_age=dense_rank(desc(st_age)),
    rank_density=dense_rank(desc(st_density)),
    rank_abasal=dense_rank(desc(st_basal_area)),
    rank_height=dense_rank(desc(st_height)),
    rank_soild=dense_rank(desc(st_soil_depth)) 
  ) %>% arrange(rank_abasal) %>% 
  dplyr::select(si_code,st_lai,st_density,st_basal_area,st_height,st_soil_depth,
                starts_with('rank')) %>% View()


sfn_allstands %>% 
dplyr::select(si_code,st_lai,st_density,st_age,st_basal_area,st_height,st_soil_depth) %>% 
  summarise_all(median,na.rm=TRUE)

```



\pagebreak

```{r dataset_duration, echo=FALSE, fig.height=18, fig.width=15, message=FALSE, warning=FALSE, cache=TRUE}
# Load data
load('dataset_duration_data.RData')

# Figure showing dataset duration and n_trees
# Palette for dataset duration plot
treeclass_pal<- c(viridis::viridis_pal(direction = 1, begin = 0.1)(7))

datasets_duration %>%
      dplyr::filter(n_trees > 0) %>%
      dplyr::mutate(index_days = seq_along(n)) %>%
      dplyr::select(si_code, index_days) %>%
      dplyr::summarise(max_days = max(index_days)) %>%
      dplyr::arrange(desc(max_days)) %>%
      dplyr::slice(1:30) -> datasets_duration_top30

data_duration_plot <-
  datasets_duration %>%
  filter(n_trees > 0) %>%
  mutate(index_days = seq_along(n)) %>%
  ggplot(
    aes(x = index_days, y = reorder(si_code, index_days, max), fill = n_trees_class_f)
  ) +
  geom_tile() +
  geom_label_repel(
    data = datasets_duration_top30,
    aes(x = max_days, y = reorder(si_code, max_days), label = si_code),
    inherit.aes = FALSE,
    hjust = 0,
    direction = 'y',
    # xlim = c(2000, NA),
    nudge_x = c(
      4000 - datasets_duration_top30$max_days[1:25],
      2500 - datasets_duration_top30$max_days[26:30]
    ),
    nudge_y = c(
      (202 - seq(198, 2, length.out = 30))[1:25] * -1,
      (202 - seq(198, 2, length.out = 30))[21:25] * -1
    ),
    force = 0,
    seed = 25
  ) +
  scale_fill_manual(values = treeclass_pal) +
  scale_x_continuous(expand = expand_scale(c(0,0), c(0, 20))) +
  labs(y = '', x = 'Number of days', fill = 'Number of trees') +
  theme_light() +
  theme(
    axis.title.x = element_text(size = 14), axis.text.x = element_text(size = 12),
    axis.text.y = element_blank(),
    legend.position = c(.2, .2), legend.text = element_text(size = 14),
    legend.title = element_text(size = 15, face = 'bold')
  )
    
  
data_period_plot <-
  datasets_duration %>%
  filter(n_trees > 0) %>%
  mutate(index_days = seq_along(n)) %>%
  ggplot(aes(x = TIMESTAMP2, y = reorder(si_code, index_days, max))) +
  geom_tile(fill = treeclass_pal[1]) +
  theme_light() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  guides(fill = 'none') +
  labs(x = "",y = 'Year') +
  theme(axis.title.x = element_text(size = 14), axis.text.x = element_text(size = 12))

# Figure composition

duration_plot_composed <- cowplot::plot_grid(
  data_duration_plot, data_period_plot,
  labels = c('(a)','(b)'), rel_widths = c(1,0.4)
)
duration_plot_composed

```

Figure 7. Datasets duration and period

\pagebreak

```{r fingerprint_plots, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=18, fig.width=15}

# Data path
path.sapwood <- file.path('data/0.1.3/RData/sapwood')

# Plot
cowplot::plot_grid(
sfn_finger_species(read_sfn_data('ESP_CAN',folder=path.sapwood)),
sfn_finger_species(read_sfn_data('USA_WVF',folder=path.sapwood),years=1998,
                   species=c('Acer saccharum','Prunus serotina','Quercus alba','Quercus rubra')),

sfn_finger_species(read_sfn_data('CRI_TAM_TOW',folder=path.sapwood),years=2015,
                   species=c('Pouteria sp.','Inga sp.',
                                            'Eschweillera sp.','Mortoniodendron anisophyllum')),
ncol=1,labels=c('a)','b)','c)'),rel_heights = c(1,1,1))

```

Figure 8. Temporal patterns.

\pagebreak

Figure 9. Environmental variables

```{r environ_vars, echo=FALSE, fig.width=15, message=FALSE, warning=FALSE}
# Venn diagrams
venn_data <- 
  sfn_env %>%
  dplyr::select(
    si_code, env_netrad, env_ppfd_in, env_precip, env_rh, env_sw_in,
    env_ta, env_vpd, env_ws, env_swc_deep_depth , env_swc_shallow_depth
  ) %>%
  gather(Variable, Value, starts_with('env_')) %>% 
  mutate(n = 1) %>%
  filter(Value != 'Not provided')

venn_list <- list(
  radiation = venn_data %>%
    filter(Variable %in% c('env_netrad', 'env_ppfd_in', 'env_sw_in')) %>%
    pull(si_code) %>%
    unique(),
  ws = venn_data %>%
    filter(Variable == 'env_ws') %>%
    pull(si_code),
  vpd = venn_data %>%
    filter(Variable == 'env_vpd') %>%
    pull(si_code),
  swc = venn_data %>%
    filter(Variable %in% c('env_swc_shallow_depth', 'env_swc_deep_depth')) %>%
    pull(si_code)
)

venn_plot <- VennDiagram::venn.diagram(
  x = venn_list,
  filename = 'resources/venn_test.tiff',
  col = 'transparent',
  fill = c("cornflowerblue", "green", "yellow", "darkorchid1"),
  alpha = 0.5
)

# Env variables  
  sfn_env %>%
  dplyr::select(si_code, env_netrad, env_ppfd_in, env_precip, env_rh, env_sw_in,
         env_ta, env_vpd, env_ws) %>%
  gather(Variable, Value, starts_with('env_')) %>% 
  mutate(n = 1) %>%
  # filter(Value != 'Not provided')
  ggplot(aes(x = Value, fill = si_code)) +
  geom_bar(aes(stat = 'count', position = 'stack')) +
  facet_grid(~Variable) +
  scale_x_discrete(breaks = c('Above canopy', 'Within canopy', 'Clearing',
                              'Off-site', 'Not provided')) +
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of sites', title = 'Environmental variables') +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = 'none',
    axis.text.x = element_text(angle = 90)
    # axis.text.y = element_text(angle = 30)
  ) -> env_freq_plot
  

# Soil 
sfn_env %>%
  dplyr::select(si_code, env_swc_shallow_depth,env_swc_deep_depth) %>%
  pivot_longer(cols=starts_with('env_'), 
               names_to='depth',
               values_to='swc',
               names_prefix = "env_swc_") %>%
  mutate(n=1,
         depth_cat=case_when(
            swc=='Not provided'~'Not provided',
           swc>0 & swc<=15 ~'0-15 cm',
           swc>15 & swc<=30 ~'16-30 cm',
           swc>30 & swc<=70~'31-70 cm',
           swc>70 & swc<=100~'71-100 cm',
           swc >100 ~ '>100 cm'),
         depth_f=factor(depth_cat,
                        levels(c('Not provided','0-15 cm','16-30 cm',
                                 '31-70 cm','71-100 cm','>100 cm')))) ->sfn_swc_freq

sfn_swc_freq$depth_meas<- factor(sfn_swc_freq$depth,levels=c('shallow_depth','deep_depth'))

soil_pal<- c('lightgrey',viridis::viridis_pal(direction=-1)(4))

sfn_swc_freq%>%
  filter(depth_cat!='Not provided') %>% 
   ggplot(aes(x=depth_meas,fill=depth_cat))+
  geom_bar(stat='count',position='stack')+
  scale_fill_manual(values=soil_pal)+
  labs(x = '', y = 'Number of sites', title = 'Soil water content') +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = 'none',
    axis.text.x = element_text(angle = 90)
    # axis.text.y = element_text(angle = 30)
  )-> swc_freq_plot



cowplot::plot_grid(env_freq_plot,swc_freq_plot, 
                   label_size = 16,labels=c('a)', 'b)'),rel_widths = c(1,0.3),
                   ncol = 2, align = "h", axis = "b")


```


```{r venn, echo=FALSE, fig.width=15, cache = FALSE}
knitr::include_graphics('resources/venn_test.tiff')
```


\pagebreak

```{r scaling, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=18, fig.width=15}
basa_area_data <-
  dataset_trees_sp %>% 
  mutate(
    sp_basal_area_perc = ifelse(si_code == 'RUS_POG_VAR', NA, sp_basal_area_perc),
    percab_measured = ifelse(si_code == 'RUS_POG_VAR', 0, percab_measured),
    sp_name_fct = as_factor(sp_name),
    typeplant = if_else(is.na(typeplant), 'no', typeplant),
    biomes_joined = case_when(
      si_biome %in% c(
        'Subtropical desert', 'Temperate grassland desert','Tropical forest savanna',
        'Temperate rain forest','Tropical rain forest'
      ) ~ 'Dry-Tropical',
      si_biome %in% c('Boreal forest','Tundra') ~ 'Boreal-Tundra',
      TRUE ~ si_biome
    )
  ) %>%
  filter(biomes_joined != 'Unknown')

biomes_plot_list <- basa_area_data %>%
  group_by(biomes_joined) %>%
  group_map(.f = function(data, key) {
    data %>%
      ggplot() +
      geom_bar(
        aes(
          x = fct_reorder(si_code, sp_basal_area_perc, sum, na.rm = TRUE),
          y = sp_basal_area_perc, fill = sp_name_fct, colour = sp_name_fct,
          alpha = typeplant
        ),
        stat = 'identity', show.legend = TRUE
      ) +
      geom_text(
        aes(
          x = fct_reorder(si_code, percab_measured, sum, na.rm = TRUE),
          y = 115,
          label = nspecies
        ),
        size = 4,
        data = data %>%
          distinct(si_code, .keep_all = TRUE),
        show.legend = FALSE
      ) +
      geom_text(
        aes(
          x = fct_reorder(si_code, percab_measured, sum, na.rm = TRUE),
          y = 125,
          label = total_ntrees
        ),
        size = 4.5, colour = 'blue',
        data = data %>%
          distinct(si_code, .keep_all = TRUE),
        show.legend = FALSE
      ) +
      labs(title = key, x = "", y = "") +
      scale_y_continuous(expand = expand_scale(c(0,0), c(0, 10))) +
      scale_colour_viridis_d(drop = FALSE) +
      scale_fill_viridis_d(drop = FALSE) +
      scale_alpha_manual(values = c(.1, 1), drop = FALSE) +
      theme_bw() +
      theme(
        legend.text = element_text(size = 12),
        legend.position = "none",
        legend.box = "horizontal",
        legend.title = element_blank(),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(hjust = 0, size = 14),
        axis.text.x = element_text(angle = 90, hjust = 1)
      )
  })

# there is a bug or something I'm doing incorrectly, but the boreal plot
# always has the alpha inverted, so...
biomes_plot_list[[1]] <- biomes_plot_list[[1]] +
  scale_alpha_manual(values = c(1,1))

biomes_grid <- 
  cowplot::plot_grid(
    plotlist = biomes_plot_list,
    nrow = 4, align = 'h'
  )

common_label_y <-
  ggdraw() +
  draw_label(
  "% of basal area measured with sap flow",
  fontface = 'bold', size = 20, angle = 90
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 2)
  )

biomes_grid_common_label <- cowplot::plot_grid(
  common_label_y, biomes_grid, ncol = 2, rel_widths = c(0.03, 1)
)

plot_legend <- get_legend(
  biomes_plot_list[[4]] +
    theme(
      legend.position = "left",
      legend.text = element_text(size = 12),
      legend.direction = "vertical",
      legend.title = element_blank(),
      legend.margin = margin(0,0,0,0)
    )
)

cowplot::plot_grid(
  plot_legend, biomes_grid_common_label, ncol = 2, rel_widths = c(0.3, 1)
)

```

Figure 10. Basal area scaling

\pagebreak

```{r wordclouds_treatments, echo = FALSE, fig.height=7, fig.width=7, message=FALSE, warning=FALSE}
library(wordcloud)
library(wordcloud2)
library(tm)
library(gridGraphics)

set.seed(63025)

# plant wordcloud
corpus_processed <- 
  sfn_allplants_tax %>%
  pull(pl_treatment) %>%
  VectorSource() %>%
  Corpus() %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace) %>%
  tm_map(content_transformer(tolower)) %>%
  tm_map(removeWords, stopwords("english")) %>%
  TermDocumentMatrix() %>%
  as.matrix() %>%
  rowSums() %>%
  sort(decreasing = TRUE)

wordcloud_data <- tibble(
  word = names(corpus_processed),
  freq = corpus_processed
)

wordcloud_plant <- function() {
  wordcloud(
    wordcloud_data[['word']], wordcloud_data[['freq']],
    min.freq = 1,
    max.words = 100,
    random.order = TRUE, rot.per = 0,
    scale = c(2.5, 0.5)
  )
}

# stand wordcloud
corpus_processed_stand <- 
  sfn_allstands %>%
  pull(st_treatment) %>%
  VectorSource() %>%
  Corpus() %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace) %>%
  tm_map(content_transformer(tolower)) %>%
  tm_map(removeWords, stopwords("english")) %>%
  TermDocumentMatrix() %>%
  as.matrix() %>%
  rowSums() %>%
  sort(decreasing = TRUE)

wordcloud_data_stand <- tibble(
  word = names(corpus_processed_stand),
  freq = corpus_processed_stand
)


wordcloud_stand <- function() {
  wordcloud(
    wordcloud_data_stand[['word']], wordcloud_data_stand[['freq']],
    min.freq = 1,
    max.words = 100,
    random.order = TRUE, rot.per = 0.15,
    scale = c(2.5, 0.25)
  )  
}

cowplot::plot_grid(
  wordcloud_plant, wordcloud_stand,
  nrow = 2, labels = c('Plant treatments', 'Stand treatments'),
  scale = c(1.2, 1.2)
)
```

Figure 11. Treatment wordclouds