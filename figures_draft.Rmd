---
title: "Figures for SAPFLUXNET data paper"
author: "R. Poyatos"
date: "27/12/2019"
output:
  word_document: 
    reference_docx: word-styles-reference-01.docx
  html_document:
    df_print: paged
  pdf_document: 
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sapfluxnetr)
library(purrr)
library(flextable)
library(pander)
library(magrittr)
library(ggplot2)
library(ggalluvial)
library(ggrepel)
library(ggbiome)
library(cowplot)
library(ggspatial)
library(raster)

source('R/sfn_datapaper_functions.R')
source('metadata_wrangling.R')
load('maps_base.RData')

```

## Figures

### Figure 1. Data workflow

### Figure 2. Geographic, bioclimatic and veg type coverage
- a) world map, b) biome plot, c) pft distribution
- TODO: world map is also shown in fig 3. Maybe go back to original idea of showing first 
the geographical distribution (now fig 3), then in another figure show biome and pft distribution.

### Figure 3. Detailed geographic distribution.
- The idea of this was to get rid of the global map, so it would not repeat somehow fig. 2. See comment
on fig. 2 ...

### Figure 4. Taxonomy.
- Major improvements by Víctor

### Figure 5. Sap flow methods and measurement level.

### Table 1. Calibrations

### Table 2. Whole-plant integration of sap flow data.

### Figure 6. Site and plant level attributes
- TODO: add titles to labels a) stand, b) plant, gymno/angio.

### Figure 7. Datasets duration and period
- Major improvements by Víctor

### Figure 8. Temporal patterns
- TODO: add titles to labels: a) ESP_CAN, Mediterranean, b), c

### Figure 9. Environmental variables

### Figure 10. Scaling.

\pagebreak

```{r data_workflow, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=18, fig.width=15}
knitr::include_graphics('resources/QC_summary2.svg')
```

Figure 1. Data workflow.

\pagebreak

```{r sitesmap, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=15, fig.width=15}
sitesmap_global <- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  guides(fill='none')+xlab(NULL)+ylab(NULL)+
  theme_light()+
  theme(axis.title=element_text(size=18),axis.text=element_text(size=18))

# TODO: preliminary filtering out climatic NAs
# Use CHELSA to gf 

biomes_plot <- sfn_allsites %>%
  dplyr::arrange(si_biome) %>%
  dplyr::filter(!is.na(si_map) | !is.na(si_map)) %>% 
  ggbiome::vis_location_biome(si_lat='si_lat',
                              si_long='si_long',si_mat='si_mat',si_map='si_map') +
  
  theme(
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    title= element_text(size=20),
    axis.title=element_text(size=20),
    axis.text=element_text(size=20),
    legend.title = element_blank(),
    legend.text = element_text(size =16),
    legend.key.size = unit(1.5, 'line'),
    legend.position = c(0.7,0.2)
    
  )

igbp_plot<-sfn_allsites %>% 
  group_by(si_igbp) %>% 
  tally() %>% 
  ggplot(.,aes(y=n,x=reorder(si_igbp,desc(n))))+
  geom_bar(stat='identity')+
  xlab('Vegetation type')+ylab('Number of datasets')+
  theme_light()+
  theme(axis.title=element_text(size=18),axis.text=element_text(size=18))

# Build figure 
cowplot::plot_grid(
  # row 1
  cowplot::plot_grid(sitesmap_global, labels='(a)'),
  # row 2
  cowplot::plot_grid(biomes_plot, igbp_plot,labels=c('(b)','(c)'),rel_widths=c(0.6,0.4)),
  ncol=1, label_size=16, rel_heights=c(0.6,0.4))

```

Figure 2. Geographical distribution of SAPFLUXNET datasets.

\pagebreak


```{r regional_maps,fig.height=18, fig.width=15, cache=TRUE,echo=FALSE, message=FALSE, warning=FALSE,}

# a) Site labels 

# b) Select countries to plot 

countries_sfn <- unique(sapply(strsplit(sfn_allsites$si_code,"_"),"[[",1))
countries_label <- c('ARG','BRA','COL','CRI','CHN','GUF','IDN','ISR','KOR','MDG','MEX','NZL','RUS','SEN','THA','UZB')
countries_europe <- c('AUT','CHE','CZE','DEU','ESP','FIN','FRA','GBR','HUN','ITA','NLD','PRT','SWE')
countries_america <- c('CAN','USA')
countries_austral <- c('AUS')
countries_africa <- c('MDG','ZAF')


# c) Add numeric codes 

sfn_allsites_country<- sfn_allsites %>% 
  mutate(country=sapply(strsplit(si_code,"_"),"[[",1),
         num_code = as.integer(factor(si_code)))


# 3. Map, numeric codes, ggrepel not aligned ------------------------------------------------------

# world
sfnsites_world_dr <- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_label), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_x = -0.35,direction = "both",
                  box.padding = unit(0.1, 'lines'), force = 0.5)+geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# europe
sfnsites_europe_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_europe), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_y = -0.35,direction = "both",
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(-20, 40), ylim = c(32, 67), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# america
sfnsites_america_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_america), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_x = -0.35,direction = "both",
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(-130, -60), ylim = c(30, 55), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# austral
sfnsites_austral_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_austral), 
                  aes(si_long, si_lat, label = num_code), size = 3,
                  segment.alpha=0.5,  nudge_x = -0.35,
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(110, 162), ylim = c(-10, -50), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)

# africa
sfnsites_africa_dr<- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  geom_text_repel(data = subset(sfn_allsites_country,country%in%countries_africa), aes(si_long, si_lat, label = num_code), size = 3,
                  box.padding = unit(0.1, 'lines'), force = 0.5)+
  coord_sf(xlim = c(10, 50), ylim = c(-10, -40), expand = FALSE)+
  geom_label_repel()+guides(fill='none')+xlab(NULL)+ylab(NULL)



# e) Build figure 

plot_grid(
  plot_grid(sfnsites_world_dr,ncol=1,nrow=1,labels=c('a)')),
  plot_grid(sfnsites_europe_dr,sfnsites_austral_dr,ncol=2,nrow=1,rel_widths=c(1,0.7),labels=c('b)','c)')),
  plot_grid(sfnsites_america_dr,sfnsites_africa_dr,ncol=2,nrow=1,rel_widths=c(1,0.7),labels=c('d)','e)')),
  nrow=3,rel_heights=c(1,1,0.7))

```
Figure 3. Detailed geographic distribution.

\pagebreak

```{r genera_species,fig.height=10, fig.width=15, echo=FALSE}

ntrees_species_top<- sfn_sitespecies_tax %>%
  group_by(genus,si_code) %>%
  mutate(n_si = sum(sp_ntrees)) %>% 
  group_by(genus) %>% 
  mutate(n_all = sum(sp_ntrees)) %>% 
  filter(n_all>50) %>% 
  ggplot(aes(x = reorder(genus, n_all, sum), y = n_si, fill = si_code)) +
 geom_bar(stat = 'identity') +
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of trees',
       title = 'Genera with > 50 trees') +
  coord_flip() +
  theme_bw() +
  theme(
    title= element_text(size=16),
    axis.title=element_text(size=16),
    axis.text=element_text(size=16),
    axis.text.y=element_text(face='italic'),
    legend.title = element_blank(),
    legend.position = 'none'
  )


ntrees_genus_top <- sfn_sitespecies_tax%>%
  filter(!is.na(sp_ntrees)) %>% 
  group_by(sp_name, si_code) %>%
  summarise(n = sum(sp_ntrees)) %>%
  group_by(sp_name) %>% 
  mutate(n_all=sum(n)) %>% 
  filter(n_all>30) %>% 
  ggplot(aes(x = reorder(sp_name, n, sum), y = n, fill = si_code)) +
  geom_bar(stat = 'identity')+
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of trees', 
       title = 'Species with >30 trees') +
  coord_flip() +
  theme_bw() +
  theme(
    title= element_text(size=16),
    axis.title=element_text(size=16),
    axis.text=element_text(size=16),
    axis.text.y=element_text(face='italic'),
    legend.title = element_blank(),
    legend.position = 'none'
  )

cowplot::plot_grid(ntrees_genus_top,ntrees_species_top,
                   label_size= 16,labels=c('a)', 'b)'),ncol=1, nrow=2, align = "v", axis = "b")
```
Figure 4. Taxonomic distribution of genera and species in SAPFLUXNET, showing (a) genera with > 50 trees and (b) species with > 30 trees in the database.

\pagebreak

```{r method_type,fig.height=18, fig.width=15, echo=FALSE}

ggplot(sfn_plants_type,
       aes(y = n, axis2 = pl_sens_meth, axis3= typef,axis1=group)) +
  geom_alluvium(aes(fill = group), width = 1/12)+
  geom_stratum(width = 1/12, alpha = .5) +
  geom_label_repel(stat = "stratum", infer.label = TRUE) +
  scale_x_discrete(limits = c("Group","Sap flow method", "Measurement level"), 
                   expand = c(.05, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1")+
  scale_fill_viridis_d()+
  ylab('Number of trees')+
  theme_minimal()+
  theme(legend.position = "none", axis.title=element_text(size=16),
        axis.text = element_text(size=16))
  
```

Figure 5. Distribution of trees in SAPFLUXNET according to sap flow method and measurement level.

\pagebreak


```{r table_calib, echo=FALSE}
sfn_allplants_tax %>% 
  group_by(pl_sens_meth) %>% 
  summarise(
    n_cal=sum(pl_sens_calib,na.rm=TRUE),
    n_noncal=sum(!pl_sens_calib,na.rm=TRUE),
    n_notprov=sum(is.na(pl_sens_calib),na.rm=TRUE),
    perc_calib = round(n_cal/(n_noncal+n_notprov)*100,1)) %>% 
  flextable() %>% 
  set_header_labels(
    pl_sens_meth='Method',
    n_cal='Calibrated',
    n_noncal='Non-calibrated',
    n_notprov='Not provided',
    perc_calib='% calibrated'
  ) %>% 
   set_caption('Table 1. Number of sap flow times series in SAPFLUXNET with species-specific calibrated data') %>% 
  autofit()

```

\pagebreak

```{r spatial_integration, echo=FALSE}

# Spatial integration of sap flow
left_join(
  #table  1 calibrations
  sfn_allplants_tax %>% 
    group_by(pl_sens_meth,pl_radial_int) %>% 
    tally()  %>% 
    pivot_wider(names_from='pl_radial_int',
                values_from='n',
                values_fill=list(n=0)) %>% 
    rename('Not provided'='NA'), # next table
 #table 2 integration
 sfn_allplants_tax %>% 
   group_by(pl_sens_meth,pl_azimut_int) %>% 
   tally()  %>% 
   pivot_wider(names_from='pl_azimut_int',
               values_from='n',
               values_fill=list(n=0)),
 by='pl_sens_meth') %>% 
  rename('Method' ='pl_sens_meth','N.provided'='NA') %>% 
  flextable(col_keys=c(
    'Method','Measured','Sensor-integrated','Corrected, measured radial variation',
    'No radial correction','Not provided',
     'measured','sensor_integrated','Corrected, measured azimuthal variation',
    'No azimuthal correction','N.provided')) %>% 
  set_header_labels(
    'measured'='Measured',
    'sensor_integrated'='Sensor-integrated',
    'N.provided'='Not provided'
  ) %>% 
  add_header_row(values=c('','Radial correction','Azimuthal correction'),colwidths=c(1,5,5)) %>% 
  align(i=1:8,align='right') %>% 
  bold(i=1,part='header') %>% 
  fontsize(size=10) %>% 
    fontsize(size=10,part='header') %>% 
  height(i=2,height=1,part='header') %>% 
  width(j=1,width=0.65) %>% 
  width(j=2:11,width=0.75) %>% 
  empty_blanks() %>% 
   set_caption('Table 2. Number of trees using different radial and azimuthal integration approaches, for 
               the different sap flow methods')



```



\pagebreak

```{r stand_plant_attributes, echo=FALSE, message=FALSE, warning=FALSE, fig.height=15, fig.width=18}

# Stand attributes --------------------------------------------------------

sfn_allstands %>%
  dplyr::select(si_code, st_age, st_height, st_density,
                        st_basal_area, st_lai, st_soil_depth) %>%
  pivot_longer(names_to="Var",values_to= "Value", cols=st_age:st_soil_depth)-> sfn_allstands_long

sfn_allstands_long$Varf <- factor(sfn_allstands_long$Var,
                                 levels=c('st_age','st_height','st_density','st_basal_area','st_lai','st_soil_depth'),
                                 labels=c('Age~(years)','Height~(m)','Stem~density~(stems~ha^{"-1"})',
                                          'Basal~area~(m^2~ha^{"-1"})','LAI~(m^2~m^{"-2"})','Soil~depth~(m)'))

sfn_allstands_long %>% 
  ggplot(.,aes(x = Var, y = Value)) +
  geom_violin(fill = '#FDE3A7', alpha = 0.3) +
  geom_point(colour='black',alpha=0.5,
             position = position_jitter(width = 0.2, height = 0))+
  facet_wrap(~Varf,scales='free',labeller=label_parsed)+
  guides(fill = FALSE) +
  labs(x=NULL,y=NULL)+
  theme_light()+
  theme(axis.text.x=element_blank(),axis.text.y=element_text(size=20),
        strip.background = element_rect(fill='white',colour='darkgray'),
        strip.text=element_text(size=20,colour='black',face='bold')) -> stand_violins

#  Plant attributes -------------------------------------------------------

sfn_allplants %>% 
  dplyr::select(pl_code,pl_dbh,pl_height,pl_sapw_area,pl_sapw_depth,pl_leaf_area) %>% 
  pivot_longer(names_to="Var", values_to="Value",cols=pl_dbh:pl_leaf_area)-> sfn_allplants_long

sfn_allplants_long$Varf <- factor(sfn_allplants_long$Var,
                                  levels=c('pl_dbh','pl_height','pl_sapw_area','pl_sapw_depth','pl_leaf_area'),
                                  labels=c('DBH~(cm)','Height~(m)','Sapwood~area~(cm^2)','Sapwood~depth~(cm)','Leaf~area(m^2)'))


sfn_allplants_long%>% 
  ggplot(.,aes(x = Var, y = Value)) +
  geom_violin(fill = '#FDE3A7', alpha = 0.3) +
  geom_point(colour='black',alpha=0.5,
             position = position_jitter(width = 0.2, height = 0))+
  facet_wrap(~Varf,scales='free',labeller=label_parsed)+
  guides(fill = FALSE) +
  labs(x=NULL,y=NULL)+
  theme_light()+
  theme(axis.text.x=element_blank(),axis.text.y=element_text(size=20),
        strip.background = element_rect(fill='white',colour='darkgray'),
        strip.text=element_text(size=20,colour='black',face='bold')) -> plant_violins

cowplot::plot_grid(stand_violins, plant_violins,labels=c('(a)','(b)'),rel_widths=c(1,1),nrow=2)

```


Figure 6. Plant and stand attributes

\pagebreak

```{r dataset_duration, echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE, fig.height=18, fig.width=15 }
# Load data
load('dataset_duration_data.RData')

  # Figure showing dataset duration and n_trees
   
  # Palette for dataset duration plot
  treeclass_pal<- c('lightgrey',viridis::viridis_pal(direction=-1)(7))
  
  data_duration_plot<- 
    datasets_duration %>% 
    ggplot(., 
           aes( y=index_days,x=reorder(num_code,n),fill = n_trees_class_f)) +
    geom_tile()+
    coord_flip()+
    scale_fill_manual(values = treeclass_pal)+
    labs(x='',y='Number of days',fill='Number of trees')+
    theme_light()+
      theme(legend.position=c(.3,.2),
            axis.title.x=element_text(size=14),axis.text.x=element_text(size=12),
            axis.text.y=element_blank())+
            
      
    geom_label_repel(data=duration_annotation %>% 
                filter(rank%in%1:30),aes(x=reorder(num_code,n),y=0.9*n,label=si_code),inherit.aes=FALSE,
                ylim=c(3800,6000),direction='y',segment.color='darkgrey',force=0.65,size=3.4,label.size=0.03,
                
                # WARNING:If size is set to 3, the final plot only shows some, not all, labels ??
                
                nudge_x=duration_annotation %>% filter(rank%in%1:30) %>% arrange(desc(n)) %>% pull(num_code)-50)
    
  
data_period_plot <- ggplot(datasets_duration, aes( y=TIMESTAMP2,x=reorder(num_code,n))) +
                        geom_tile(fill = treeclass_pal[7])+
                        coord_flip()+
  theme_light()+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
guides(fill='none')+labs(x="",y='Year')+
  theme(axis.title.x=element_text(size=14),axis.text.x=element_text(size=12))

# Figure composition

cowplot::plot_grid(data_duration_plot, data_period_plot,labels=c('(a)','(b)'),rel_widths=c(1,0.4))


```

Figure 7. Datasets duration and period

\pagebreak

```{r fingerprint_plots, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=18, fig.width=15}

# Data path
path.sapwood <- file.path('data/0.1.3/RData/sapwood')

# Plot
cowplot::plot_grid(
sfn_finger_species(read_sfn_data('ESP_CAN',folder=path.sapwood)),
sfn_finger_species(read_sfn_data('USA_WVF',folder=path.sapwood),years=1998,
                   species=c('Acer saccharum','Prunus serotina','Quercus alba','Quercus rubra')),

sfn_finger_species(read_sfn_data('CRI_TAM_TOW',folder=path.sapwood),years=2015,
                   species=c('Pouteria sp.','Inga sp.',
                                            'Eschweillera sp.','Mortoniodendron anisophyllum')),
ncol=1,labels=c('a)','b)','c)'),rel_heights = c(1,1,1))

```

Figure 8. Temporal patterns.

\pagebreak

Figure 9. Environmental variables

```{r  environ_vars, echo=FALSE,   fig.width=15}

# Env variables  
  sfn_env %>%
  dplyr::select(si_code, env_netrad, env_ppfd_in, env_precip, env_rh, env_sw_in,
         env_ta, env_vpd, env_ws) %>%
  gather(Variable, Value, starts_with('env_')) %>% 
  mutate(n = 1) %>%
  ggplot(aes(x = Value, fill = si_code)) +
  geom_bar(aes(stat = 'count', position = 'stack')) +
  facet_grid(~Variable) +
  scale_x_discrete(breaks = c('Above canopy', 'Within canopy', 'Clearing',
                              'Off-site', 'Not provided')) +
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of sites', title = 'Environmental variables') +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = 'none',
    axis.text.x = element_text(angle = 90)
    # axis.text.y = element_text(angle = 30)
  ) -> env_freq_plot
  

# Soil 
sfn_env %>%
  dplyr::select(si_code, env_swc_shallow_depth,env_swc_deep_depth) %>%
  pivot_longer(cols=starts_with('env_'), 
               names_to='depth',
               values_to='swc',
               names_prefix = "env_swc_") %>%
  mutate(n=1,
         depth_cat=case_when(
            swc=='Not provided'~'Not provided',
           swc>0 & swc<=15 ~'0-15 cm',
           swc>15 & swc<=30 ~'16-30 cm',
           swc>30 & swc<=70~'31-70 cm',
           swc>70 & swc<=100~'71-100 cm',
           swc >100 ~ '>100 cm'),
         depth_f=factor(depth_cat,
                        levels(c('Not provided','0-15 cm','16-30 cm',
                                 '31-70 cm','71-100 cm','>100 cm')))) ->sfn_swc_freq

sfn_swc_freq$depth_meas<- factor(sfn_swc_freq$depth,levels=c('shallow_depth','deep_depth'))

soil_pal<- c('lightgrey',viridis::viridis_pal(direction=-1)(4))

sfn_swc_freq%>%
  filter(depth_cat!='Not provided') %>% 
   ggplot(aes(x=depth_meas,fill=depth_cat))+
  geom_bar(stat='count',position='stack')+
  scale_fill_manual(values=soil_pal)+
  labs(x = '', y = 'Number of sites', title = 'Soil water content') +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = 'none',
    axis.text.x = element_text(angle = 90)
    # axis.text.y = element_text(angle = 30)
  )-> swc_freq_plot



cowplot::plot_grid(env_freq_plot,swc_freq_plot,
                   label_size= 16,labels=c('a)', 'b)'),rel_widths = c(1,0.3),
                   ncol=2, nrow=1, align = "h", axis = "b")


```




\pagebreak

