---
title: 'Global transpiration data from sap flow measurements: the SAPFLUXNET database'
subtitle: 'Figures and tables'
author: "R. Poyatos"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  word_document:
    reference_docx: word-styles-reference-01.docx
  html_document:
    df_print: paged
  pdf_document: 
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sapfluxnetr)
library(purrr)
library(flextable)
library(pander)
library(magrittr)
library(ggplot2)
library(ggalluvial)
library(ggrepel)
#library(ggbiome)
library(cowplot)
library(ggspatial)
library(raster)
library(VennDiagram)
library(forcats)

source('R/sfn_datapaper_functions.R')
source('metadata_wrangling.R')
load('maps_base.RData')

```
## Table captions

**Table 1.** Number of sap flow times series in SAPFLUXNET with species-specific calibrated data 
for the different sap flow methods: cyclic (or transient) heat dissipation (CHD), compensation heat pulse (CHP),
heat dissipation (HD), heat field deformation (HFD), heat pulse T-max (HPTM), heat ratio (HR), 
stem heat balance (SHB) and trunk sector heat balance (TSHB).

**Table 2.** Number of plants using different radial and azimuthal integration approaches
for the different sap flow methods: cycling heat dissipation (CHD), compensation heat pulse (CHP),
heat dissipation (HD), heat field deformation (HFD), heat pulse T-max (HPTM), heat ratio (HR), 
stem heat balance (SHB) and trunk sector heat balance (TSHB).

**Table 3.** Number of datasets, plants and species according to treatment at the stand level.

## Figure captions

**Figure 1.** Overview of the SAPFLUXNET data workflow. Data files are received 
from data contributors, and undergo several quality control processes (QC1 and QC2). 
Both, QC1 and QC2 produce an .RData object of the custom-designed sfn-data S4 class 
storing all data, metadata and data flags for each dataset. The progress and results of the QC
processes are monitored through individual reports and log files. The final outcome, 
is stored in a folder structure with a either single .RData file for each dataset or a
set of seven csv files for each dataset.

**Figure 2.** (a) Geographic, (b) bioclimatic and (c) vegetation type distribution 
of SAPFLUXNET datasets. In (b) we represent the different 
datasets according to their mean annual temperature and precipitation in a Whittaker 
diagram showing the classification of the main terrestrial biomes. In (c) vegetation types
are defined according to IGBP classification (ENF: Evergreen Needleleaf Forest; 
DBF: Deciduous Broadleaf Forest; EBF: Evergreen Broadleaf Forest; MF: Mixed Forest; 
DNF: Deciduous Needleleaf forest; SAV: Savannas; WSA: Woody Savannas; WET: Permanent Wetlands).
Woodland area from Crowther et al. (2015) shown in green.

**Figure 3.** Taxonomic distribution of genera and species in SAPFLUXNET, showing 
(a) species and (b) genera with > 50 plants in the database. Total bar height depicts 
number of plants per species (a) or genera (b). Numbers on top of each bar show the number of datasets
where each species (a) or genus (b) is present. Colors other than grey highlight datasets
with 15 or more plants of a given species (a) or genus (b). Bar height for a given color
is proportional to the number of plants in the corresponding dataset, which is also shown in parentheses
next to the dataset code.

**Figure 4.** Distribution of plants in SAPFLUXNET according to major taxonomic group 
(angiosperms, gymnosperms), sap flow method (CHD:cycling heat dissipation; CHP: compensation heat pulse; 
HD: heat dissipation; HFD: heat field deformation: HPTM: heat pulse T-max (HPTM): HRM: heat ratio (HR); 
SHB: stem heat balance; TSHB: trunk sector heat balance) and reference unit for the expression of
sap flow (plant, sapwood area, leaf area).

**Figure 5.** Ecological representativeness of SAPFLUXNET plants and stands. 
Panel (a) shows the distribution of plants according to their taxonomic group
(angiosperms, gymnosperms) and their main individual attributes: 
diameter at breast height (DBH), plant height, sapwood area, sapwood 
depth and leaf area. The inset in the sapwood area panel zooms in values lower than 
5000 cmÂ². Panel (b) shows the distribution of SAPFLUXNET stands 
according to their main attributes: stand age, stand height, stem density, 
stand basal area,leaf area index (LAI) and soil depth.

**Figure 6.** (a) Duration of SAPFLUXNET datasets expressed in number of days with
sap flow data and coloured by the number of plants measured on each day . The 30 longest datasets
are labelled. For each dataset in panel (a), panel (b) shows its corresponding 
measurement period.

**Figure 7.** Fingerprint plots showing hourly sap flow per unit sapwood area (colour scale) 
as a function of hour of day (x-axis) and day of year (y-axis) for a selection 
of SAPFLUXNET sites with at least four co-occurring species.
Panel (a) shows data from a Woodland/Shrubland forest in NE Spain (ESP_CAN), 
for an average (2011) and a dry (2012) year. Panel (b) shows data for a mesic 
Temperate forest (USA_WVF) and panel (c) shows data for a Tropical
forest (CRI_TAM_TOW). For this latter site, only 4 of the 17 measured species are
shown and some of them were only identified at the genus level.

**Figure 8.** Summary of the availability of different environmental variables in
SAPFLUXNET datasets. (a) Distribution of meteorological variables according to 
measurement location (in brackets, names of the variables in the database), 
(b) Distribution of soil moisture variables according to the
measurement depth (in brackets, names of the variables in the database). 
(c) Venn diagram showing the number of datasets where certain combinations of different 
environmental variables are present, grouping shortwave, PPFD and net radiation under 
'Radiation' variables.

**Figure 9.** Potential for upscaling individual plant sap flow to stand-level sap flow
using SAPFLUXNET datasets, classified using an aggregated biome classification; 
'Dry-Tropical' include: 'Subtropical desert', 'Temperate grassland desert','Tropical forest savanna'
and 'Tropical rain forest'. Each panel shows the percentage 
of total stand basal area that is covered by sap flow measurements for each species 
in the dataset. Datasets are also coloured by the number of species present. Numbers 
on top of each bar depict the total number of plants for a given dataset. Empty bars show 
datasets for which plant-level data are not available.


\pagebreak

```{r data_workflow, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE,fig.align='center'}
# SVG can't be visualised in Word
# knitr::include_graphics('resources/QC_process.svg')

knitr::include_graphics('resources/QC_process.png')
```

**Figure 1.**

\pagebreak

```{r sitesmap, echo=FALSE, fig.width=8, message=FALSE, warning=FALSE, cache=FALSE}
sitesmap_global <- globforest_rec_0_1  +
  geom_point(
    data=sfn_allsites,
    aes(x=si_long,y=si_lat),
    shape=21,color='black',
    fill='royalblue',
    alpha=0.5, size = 3
  )+
  guides(fill='none')+xlab(NULL)+ylab(NULL)+
  theme_light()+
  theme(axis.title=element_text(size=12),axis.text=element_text(size=12))

# TODO: preliminary filtering out climatic NAs
# Use CHELSA to gf 

biomes_plot <- sfn_allsites %>%
  dplyr::arrange(si_biome) %>%
  dplyr::filter(!is.na(si_map) | !is.na(si_map)) %>% 
  vis_location_biome() +
  theme_light() +
  theme(
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    title= element_text(size=12),
    axis.title=element_text(size=12),
    axis.text=element_text(size=12),
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.60, 'line'),
    legend.position = c(0.73,0.27),
    legend.background = element_blank()
    
  )

igbp_plot<-sfn_allsites %>% 
  group_by(si_igbp) %>% 
  tally() %>% 
  ggplot(.,aes(y=n,x=reorder(si_igbp,desc(n))))+
  geom_bar(stat='identity', fill = viridis::viridis(1))+
  xlab('Vegetation type')+ylab('Number of datasets')+
  theme_light()+
  theme(axis.title=element_text(size=12),axis.text=element_text(size=12))

temp_align_plots <- cowplot::align_plots(
  sitesmap_global, biomes_plot, align = 'v', axis = 'l'
)

# Build figure 
biomes_igbp_grid <- cowplot::plot_grid(
  biomes_plot, igbp_plot,
  labels=c('(b)','(c)'), rel_widths=c(0.5,0.5), label_size=12, vjust = -0.5
)

fig_2 <- cowplot::plot_grid(
  NULL, temp_align_plots[[1]], NULL, biomes_igbp_grid,
  labels = c('', '(a)', '', ''), label_size = 12,
  nrow = 4, rel_heights = c(0.03, 0.5, 0.03, 0.5), vjust = 0
)

cowplot::save_plot(
  'Fig_2.pdf', fig_2, nrow = 1, base_height = 15, base_width = 20,
  units = 'cm'
)

knitr::include_graphics('Fig_2.pdf')

```

**Figure 2.** 

\pagebreak

```{r genera_species, message=FALSE, warning=FALSE,fig.height=15, fig.width=12, echo=FALSE}

sfn_sitespecies_tax %>%
  group_by(genus,si_code) %>%
  summarise(n_si = sum(sp_ntrees)) %>% 
  group_by(genus) %>% 
  mutate(
    n_all = sum(n_si),
    vjust = n_si/sum(n_si),
    fill_dummy = if_else(n_si > 14, si_code, 'zz_other')
  ) %>%
  filter(n_all>50) %>%
  arrange(desc(n_si)) %>%
  mutate(
    accumulated = cumsum(n_si),
    segment_start = accumulated - (n_si/2)
  ) -> ntrees_species_top_data

ntrees_species_top_data %>%
  # only show label for those sites in each genus with 15 trees or more
  filter(n_si > 14) -> ntrees_species_top_data_labels

number_sites_labels <-
  ntrees_species_top_data %>%
  count() %>%
  mutate(x_label = paste0(n, ' sites'), y = 800) %>%
  left_join(
    ntrees_species_top_data %>%
      dplyr::select(genus, n_all) %>%
      distinct()
  )

ntrees_species_top <-
  ntrees_species_top_data %>% 
  ggplot(aes(x = reorder(genus, n_all), y = n_si, fill = reorder(fill_dummy, n_si))) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  geom_text(
    aes(label = n, y = y, x = reorder(genus, n_all)),
     size=3,fontface='bold',colour='black',
    data = number_sites_labels, inherit.aes = FALSE
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Pinus'),
    # position = 'identity',
    size = 2,
    # repel options
    nudge_x = 2.8,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Quercus'),
    # position = 'identity',
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 520 - ntrees_species_top_data_labels %>% filter(genus == 'Quercus') %>% pull(segment_start),
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Acer'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 260 - ntrees_species_top_data_labels %>% filter(genus == 'Acer') %>% pull(segment_start),
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Picea'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 400 - ntrees_species_top_data_labels %>% filter(genus == 'Picea') %>% pull(segment_start),
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Eucalyptus'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 210,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Fagus'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 280,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Populus'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 100,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Abies'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 60,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Acacia'),
    size = 2,
    # repel options
    nudge_x = 0.75,
    nudge_y = 125,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  scale_fill_manual(values = c('grey88', viridis::viridis(30))) +
  scale_y_continuous(expand = expansion(c(0,0), c(0,100))) +
  scale_x_discrete(expand = expansion(c(0,0), c(1,2.5))) +
  # viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of plants',
       title = '') +
  # coord_flip() +
  theme_light() +
  theme(
    title= element_text(size = 11),
    axis.title=element_text(size = 12),
    axis.text.y=element_text(size = 12),
    axis.text.x=element_text(size=12,face='italic', angle = 30, vjust = 0.9, hjust = 0.8),
    legend.title = element_blank(),
    legend.position = 'none'
  )

# species plot
sfn_sitespecies_tax%>%
  filter(!is.na(sp_ntrees)) %>% 
  group_by(sp_name, si_code) %>%
  summarise(n = sum(sp_ntrees)) %>%
  group_by(sp_name) %>% 
  mutate(
    n_all=sum(n),
    vjust = n/sum(n),
    fill_dummy = if_else(n > 14, si_code, 'zz_other')
  ) %>% 
  filter(n_all>50) %>%
  arrange(desc(n)) %>%
  mutate(
    accumulated = cumsum(n),
    segment_start = accumulated - (n/2)
  ) -> ntrees_genus_top_data

ntrees_genus_top_data %>%
  # only show label for those sites in each genus with 15 trees or more
  filter(n > 14) -> ntrees_genus_top_data_labels

number_sites_labels_genus <-
  ntrees_genus_top_data %>%
  count() %>%
  mutate(x_label = paste0(n, ' sites'), y = 330) %>%
  left_join(
    ntrees_genus_top_data %>%
      dplyr::select(sp_name, n_all) %>%
      distinct()
  )

ntrees_genus_top <- 
  ntrees_genus_top_data %>% 
  ggplot(aes(x = reorder(sp_name, n_all), y = n, fill = reorder(fill_dummy, n))) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  geom_text(
    aes(label = n, y = y, x = reorder(sp_name, n_all)),
    size=3,fontface='bold',colour='black',
    data = number_sites_labels_genus, inherit.aes = FALSE
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus sylvestris'),
    size = 2,
    # repel options
    nudge_x = 2.8,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Picea abies'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = 190,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Acer saccharum'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = c(125, 50),
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus taeda'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Populus tremuloides'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = 85,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus koraiensis'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = c(160, 120, 80),
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus strobus'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Quercus ilex'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = 85,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Acer rubrum'),
    size = 2,
    # repel options
    nudge_x = 0.75, nudge_y = 60,
    hjust = 1,
    direction = 'y', min.segment.length = 1000, seed = 25
  ) +
  scale_fill_manual(values = c('grey88', viridis::viridis(19))) +
  scale_y_continuous(expand = expansion(c(0,0), c(0,50))) +
  scale_x_discrete(expand = expansion(c(0,0), c(1,2.5))) +
  # viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of plants', 
       title = '') +
  # coord_flip() +
  theme_light() +
  theme(
    title= element_text(size = 11),
    axis.title=element_text(size = 12),
   axis.text.y=element_text(size = 12),
    axis.text.x=element_text(size=12,face='italic', angle = 30, vjust = 0.9, hjust = 0.8),
    legend.title = element_blank(),
    legend.position = 'none'
  )

fig_3 <- cowplot::plot_grid(
  ntrees_genus_top,ntrees_species_top,
  label_size= 12,
  labels=c('(a) Species with >50 plants', '(b) Genera with >50 plants'),
  vjust = 1.7, hjust = -0.05,
  ncol=1, nrow=2, align = "v", axis = "b"
)

cowplot::save_plot(
  'Fig_3.pdf', fig_3, nrow = 1, base_height = 25, base_width = 20,
  units = 'cm'
)

fig_3
```
**Figure 3.** 

\pagebreak

```{r method_type,fig.height=15, fig.width=15, echo=FALSE}
fig_4 <- sfn_plants_type %>%
  ggplot(aes(
    y = n,
    axis3 = pl_sens_meth,
    axis1 = typef,
    axis2 = group
  )) +
  geom_alluvium(aes(fill = group), width = 1/12)+
  geom_stratum(width = 1/12, alpha = 0.2) +
  geom_label_repel(
    stat = "stratum", infer.label = TRUE,size=3,
    direction = 'both',
    # nudge_x = c(rep(-0.2, 8), rep(0.05, 2), rep(0.2, 2), 0.05, 0.2)
    nudge_x = c(rep(-0.2, 2), -0.05, -0.2, rep(0.05, 2), rep(0.2, 8)), seed = 25
  ) +
  scale_x_discrete(limits = c("Reference unit", "Taxonomic group", "Sap flow method"), 
                   expand = c(.2, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1")+
  scale_fill_viridis_d()+
  ylab('Number of plants')+
  theme_light()+
  theme(legend.position = "none", axis.title=element_text(size=12),
        axis.text = element_text(size=12))

cowplot::save_plot(
  'Fig_4.pdf', fig_4, nrow = 1, base_height = 15, base_width = 15,
  units = 'cm'
)

fig_4
  
```
**Figure 4.** 

\pagebreak


```{r table_calib, echo=FALSE}
sfn_allplants_tax %>% 
  group_by(pl_sens_meth) %>% 
  summarise(
    n_cal=sum(pl_sens_calib,na.rm=TRUE),
    n_noncal=sum(!pl_sens_calib,na.rm=TRUE),
    n_notprov=sum(is.na(pl_sens_calib),na.rm=TRUE),
    perc_calib = round(n_cal/(n_noncal+n_notprov)*100,1)) %>% 
  flextable() %>% 
  set_header_labels(
    pl_sens_meth='Method',
    n_cal='Calibrated',
    n_noncal='Non-calibrated',
    n_notprov='Not provided',
    perc_calib='% calibrated'
  ) %>% 
   set_caption('Table 1') %>% 
  autofit()

```

\pagebreak

```{r spatial_integration, echo=FALSE}

# Spatial integration of sap flow
left_join(
  #table  1 calibrations
  sfn_allplants_tax %>% 
    group_by(pl_sens_meth,pl_radial_int) %>% 
    tally()  %>% 
    pivot_wider(names_from='pl_radial_int',
                values_from='n',
                values_fill=list(n=0)) %>% 
    rename('Not provided'='NA'), # next table
 #table 2 integration
 sfn_allplants_tax %>% 
   group_by(pl_sens_meth,pl_azimut_int) %>% 
   tally()  %>% 
   pivot_wider(names_from='pl_azimut_int',
               values_from='n',
               values_fill=list(n=0)),
 by='pl_sens_meth') %>% 
  rename('Method' ='pl_sens_meth','N.provided'='NA') %>% 
  flextable(col_keys=c(
    'Method','Measured','Sensor-integrated','Corrected, measured radial variation',
    'No radial correction','Not provided',
     'measured','sensor_integrated','Corrected, measured azimuthal variation',
    'No azimuthal correction','N.provided')) %>% 
  set_header_labels(
    'measured'='Measured',
    'sensor_integrated'='Sensor-integrated',
    'N.provided'='Not provided'
  ) %>% 
  add_header_row(values=c('','Radial integration','Azimuthal integration'),colwidths=c(1,5,5)) %>% 
  align(i=1:8,align='right') %>% 
  bold(i=1,part='header') %>% 
  fontsize(size=10) %>% 
    fontsize(size=10,part='header') %>% 
  height(i=2,height=1,part='header') %>% 
  width(j=1,width=0.65) %>% 
  width(j=2:11,width=0.75) %>% 
  empty_blanks() %>% 
   set_caption('Table 2')



```


\pagebreak

```{r stand_plant_attributes, echo=FALSE, message=FALSE, warning=FALSE, fig.height=15, fig.width=18}

# Stand attributes --------------------------------------------------------

sfn_allstands_long <- 
  sfn_allstands %>%
  dplyr::select(
    si_code, st_age, st_height, st_density, st_basal_area, st_lai, st_soil_depth
  ) %>%
  pivot_longer(names_to = "Var", values_to = "Value", cols=st_age:st_soil_depth) %>%
  mutate(
    Varf = forcats::as_factor(Var) %>% forcats::fct_relabel(
      ~ c(
        'Age~(years)','Height~(m)','Stem~density~(stems~ha^{"-1"})',
        'Basal~area~(m^2~ha^{"-1"})','LAI~(m^2~m^{"-2"})','Soil~depth~(cm)'
      )
    )
  )

stand_violins <-
  sfn_allstands_long %>% 
  ggplot(.,aes(x = Var, y = Value)) +
  geom_violin(fill = viridis::viridis(1, begin = 0.5), alpha = 0.3) +
  geom_point(colour = viridis::viridis(1, begin = 0.5),alpha = 0.5,
             position = position_jitter(width = 0.2, height = 0)) +
  facet_wrap(~Varf,scales = 'free', labeller = label_parsed) +
  guides(fill = FALSE) +
  labs(x = NULL, y = NULL) +
  theme_light() +
  theme(axis.text.x = element_blank(),axis.text.y = element_text(size = 12),
        strip.background = element_rect(fill = 'white', colour = 'darkgray'),
        strip.text = element_text(size = 12, colour = 'black', face = 'bold'))

#  Plant attributes -------------------------------------------------------

sfn_allplants_long <-
  sfn_allplants_tax %>%
  dplyr::select(
    pl_code, pl_dbh, pl_height, pl_sapw_area, pl_sapw_depth, pl_leaf_area, group
  ) %>% 
  pivot_longer(names_to = "Var", values_to = "Value", cols = pl_dbh:pl_leaf_area) %>% 
  mutate(
    Varf = forcats::as_factor(Var) %>% forcats::fct_relabel(
      ~ c(
        'DBH~(cm)', 'Height~(m)', 'Sapwood~area~(cm^2)',
        'Sapwood~depth~(cm)', 'Leaf~area(m^2)'
      )
    )
  )

plant_violins <-
  sfn_allplants_long %>% 
  ggplot(aes(x = Var, y = Value, fill = group)) +
  geom_split_violin(alpha = 0.5) +
  # data points angios
  geom_point(
    aes(x = 0.75),
    data = sfn_allplants_long %>%
      filter(group == 'Angiosperms'),
    colour = viridis::viridis(1), alpha=0.2,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # median point angios
  geom_errorbarh(
    data = sfn_allplants_long %>%
        filter(group == 'Angiosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(xmin = 0.95, xmax = 1.05, y = median, fill = NA, height = 0),
    colour = 'white', size = 0.8,
    position = position_nudge(x = -0.03)
  ) +
  geom_point(
    data = sfn_allplants_long %>%
        filter(group == 'Angiosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = Var, y = median),
    colour = 'white', size = 3, shape = 23, fill = viridis::viridis(1),
    position = position_nudge(x = -0.03)
  ) +
  # data points gymnos
  geom_point(
    aes(x = 1.25),
    data = sfn_allplants_long %>%
      filter(group == 'Gymnosperms'),
    colour = viridis::viridis(1, direction = -1), alpha=0.2,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # median point gymnos
  geom_errorbarh(
    data = sfn_allplants_long %>%
        filter(group == 'Gymnosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(xmin = 0.95, xmax = 1.05, y = median, fill = NA, height = 0),
    colour = 'black', size = 0.8,
    position = position_nudge(x = 0.03)
  ) +
  geom_point(
    data = sfn_allplants_long %>%
        filter(group == 'Gymnosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = Var, y = median),
    colour = 'black', size = 3,
    shape = 23, fill = viridis::viridis(1, direction = -1),
    position = position_nudge(x = 0.03)
  ) +
  facet_wrap(~Varf,scales='free',labeller=label_parsed) +
  scale_fill_viridis_d() +
  labs(x=NULL,y=NULL)+
  theme_light() +
  guides(fill = guide_legend(title = 'Taxonomic group')) +
  theme(
    axis.text.x = element_blank(), axis.text.y = element_text(size = 12),
    strip.background = element_rect(fill = 'white', colour='darkgray'),
    strip.text = element_text(size = 12, colour = 'black', face = 'bold'),
    legend.position = c(0.85, 0.25), legend.text = element_text(size = 12),
    legend.title = element_text(size = 12, face = 'bold')
  )


# Inset for sapwood depth

 sfn_allplants_long %>% 
   filter(Var=='pl_sapw_area' & Value<5000) -> sfn_allplants_long_sw

sw_inset<- sfn_allplants_long_sw %>% 
  ggplot(aes(x = Var, y = Value, fill = group)) +
  # data points angios
  geom_point(
    aes(x = 0.75),
    data = sfn_allplants_long_sw %>%
      filter(group == 'Angiosperms'),
    colour = viridis::viridis(1), alpha=0.2, size = 0.5,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # data points gymnos
  geom_point(
    aes(x = 1),
    data = sfn_allplants_long_sw %>%
      filter(group == 'Gymnosperms'),
    colour = viridis::viridis(1, direction = -1), alpha=0.2, size = 0.5,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  
  geom_point(
    data = sfn_allplants_long %>%
        filter(Var == 'pl_sapw_area',group == 'Angiosperms') %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = .75, y = median),
    colour = 'white', size = 1, shape = 23, fill = viridis::viridis(1)
  )+
  
  geom_point(
    data = sfn_allplants_long %>%
        filter(Var == 'pl_sapw_area',group == 'Gymnosperms') %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = 1, y = median),
    colour = 'black', size = 1, shape = 23, fill = viridis::viridis(1,direction=-1)
  )+
  
  labs(x=NULL,y=NULL)+
  theme_light()+
  theme(axis.text.x = element_blank(),axis.text.y=element_text(size=8),
        panel.grid = element_blank(), axis.ticks.x = element_blank())


## This function allows us to specify which facet to annotate
# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data) 
{
  layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = FALSE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}


# Add inset to plant violins

plant_violins_inset<- plant_violins+
  annotation_custom2(grob=ggplotGrob(sw_inset), 
                      data = data.frame(Varf='Sapwood~area~(cm^2)'),
                      ymin = 7000, ymax=15000, xmin=1.05, xmax=1.6)


# Compose plot

fig_5 <- cowplot::plot_grid(
  NULL, plant_violins_inset, NULL, stand_violins,
  labels = c('', '(a) Plant attributes', '', '(b) Stand attributes'),
  vjust = -1, hjust = -0.1,
  rel_widths = c(1,1,1,1), nrow = 4, rel_heights = c(0.1, 1, 0.1, 1),
  label_size = 12, align = 'hv'
)

cowplot::save_plot(
  'Fig_5.pdf', fig_5, nrow = 1, base_height = 21, base_width = 20, units = 'cm'
)

fig_5


```
**Figure 5.** 


```{r attributes_text, include=FALSE}

sfn_allplants_tax %>% 
  dplyr::select(pl_dbh,pl_height,pl_age,pl_sapw_area,pl_sapw_depth) %>% 
 map_df(~sum(is.na(.))/length(.)*100)


sfn_allplants_tax %>% 
  mutate(rank_dbh = dense_rank(desc(pl_dbh)),
         rank_sapw_area =dense_rank(desc(pl_sapw_area)),
         rank_sap_depth=dense_rank(desc(pl_sapw_depth)),
         rank_leaf_area=dense_rank(desc(pl_leaf_area))) %>% 
  arrange(rank_sapw_area) %>% 
  dplyr::select(si_code,pl_species,pl_dbh,pl_sapw_area,pl_sapw_depth,starts_with('rank')) 
  

sfn_allstands  %>% 
  dplyr::select(si_code,st_lai,st_density,st_basal_area,st_height,st_soil_depth) %>% 
 map_df(~sum(is.na(.))/length(.)*100)


sfn_allstands %>% 
  mutate(
    rank_lai= dense_rank(desc(st_lai)),
    rank_age=dense_rank(desc(st_age)),
    rank_density=dense_rank(desc(st_density)),
    rank_abasal=dense_rank(desc(st_basal_area)),
    rank_height=dense_rank(desc(st_height)),
    rank_soild=dense_rank(desc(st_soil_depth)) 
  ) %>% arrange(rank_abasal) %>% 
  dplyr::select(si_code,st_lai,st_density,st_basal_area,st_height,st_soil_depth,
                starts_with('rank')) 


sfn_allstands %>% 
dplyr::select(si_code,st_lai,st_density,st_age,st_basal_area,st_height,st_soil_depth) %>% 
  summarise_all(median,na.rm=TRUE)

# Plant size: angio vs gymno
sfn_allplants_tax %>% 
  group_by(group) %>% 
  summarise_at(vars(pl_dbh,pl_height,pl_sapw_area,pl_sapw_depth,pl_leaf_area),median, na.rm=TRUE)

# Stand

sfn_allstands %>% 
  summarise_at(vars(st_basal_area,st_height,st_age,st_density,st_lai,st_soil_depth),function(x) sum(is.na(x))/length(x))


sfn_allstands %>% 
  summarise_at(vars(st_basal_area,st_height,st_age,st_density,st_lai,st_soil_depth),median,na.rm=TRUE)

  


```

\pagebreak

```{r dataset_duration, echo=FALSE, fig.height=18, fig.width=15, message=FALSE, warning=FALSE, cache=FALSE}
# Load data
load('dataset_duration_data.RData')

# Figure showing dataset duration and n_trees
# Palette for dataset duration plot
treeclass_pal<- c(viridis::viridis_pal(direction = 1, begin = 0.1)(7))

datasets_duration %>%
      dplyr::filter(n_trees > 0) %>%
      dplyr::mutate(index_days = seq_along(n)) %>%
      dplyr::select(si_code, index_days) %>%
      dplyr::summarise(max_days = max(index_days)) %>%
      dplyr::arrange(desc(max_days)) %>%
      dplyr::slice(1:30) -> datasets_duration_top30

data_duration_plot <-
  datasets_duration %>%
  filter(n_trees > 0) %>%
  mutate(index_days = seq_along(n)) %>%
  ggplot(
    aes(x = index_days, y = reorder(si_code, index_days, max), fill = n_trees_class_f)
  ) +
  geom_tile() +
  geom_label_repel(
    data = datasets_duration_top30,
    aes(x = max_days, y = reorder(si_code, max_days), label = si_code),
    inherit.aes = FALSE,
    hjust = 0,
    direction = 'y',
    # xlim = c(2000, NA),
    nudge_x = c(
      4000 - datasets_duration_top30$max_days[1:25],
      2500 - datasets_duration_top30$max_days[26:30]
    ),
    nudge_y = c(
      (202 - seq(198, 2, length.out = 30))[1:25] * -1,
      (202 - seq(198, 2, length.out = 30))[21:25] * -1
    ),
    force = 0,
    seed = 25,
    size = 2
  ) +
  scale_fill_manual(values = treeclass_pal) +
  scale_x_continuous(expand = expansion(c(0,0), c(0, 20))) +
  labs(y = '', x = 'Number of days', fill = 'Number of plants') +
  ggtitle('')+
  theme_light() +
  theme(
    axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12),
    axis.text.y = element_blank(),
    legend.position = c(.2, .15), legend.text = element_text(size = 10),
    legend.title = element_text(size = 12, face = 'bold'),
    legend.background = element_blank()
  )
    
  
data_period_plot <-
  datasets_duration %>%
  filter(n_trees > 0) %>%
  mutate(index_days = seq_along(n)) %>%
  ggplot(aes(x = TIMESTAMP2, y = reorder(si_code, index_days, max))) +
  geom_tile(fill = treeclass_pal[1]) +
  ggtitle('')+
  theme_light() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  guides(fill = 'none') +
  labs(x = "Year",y = '') +
  theme(axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12))

# Figure composition

fig_6 <- cowplot::plot_grid(
  data_duration_plot, data_period_plot,
  labels = c('(a)','(b)'), rel_widths = c(1,0.4),
  label_size=12
)

cowplot::save_plot(
  'Fig_6.pdf', fig_6, nrow = 1, base_height = 21, base_width = 20, units = 'cm'
)

fig_6

```

**Figure 6.**

```{r duration_text, include=FALSE, echo=FALSE}

# Values for dataset duration narrative
datasets_duration %>% 
  dplyr::select(si_code,TIMESTAMP,ini_date,end_date) %>% 
  mutate(year=lubridate::year(TIMESTAMP)) %>% 
  group_by(si_code) %>% 
  distinct(si_code,year) %>% 
  group_by(si_code) %>% 
  summarise(n_years=n_distinct(year)) %>% 
  arrange(desc(n_years)) 

```


\pagebreak

```{r fingerprint_plots, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=18, fig.width=15}

# Functions
source('R/sfn_datapaper_functions.R')

# Data path
path.sapwood <- file.path('data/0.1.5/RData/sapwood')

# Plot
fig_7 <- cowplot::plot_grid(
  NULL,
sfn_finger_species(read_sfn_data('ESP_CAN',folder=path.sapwood))+
  theme(
    axis.title = element_text(size = 12), axis.text.x = element_text(size = 8),
    panel.grid.minor = element_blank()
  ) +
  labs(x = ''),
NULL,
sfn_finger_species(read_sfn_data('USA_WVF',folder=path.sapwood),years=1998,
                   species=c('Acer saccharum','Prunus serotina','Quercus alba','Quercus rubra'))+
  theme(
    axis.title = element_text(size = 12), axis.text.x = element_text(size = 8),
    panel.grid.minor = element_blank()
  ) +
  labs(x = ''),
NULL,
sfn_finger_species(read_sfn_data('CRI_TAM_TOW',folder=path.sapwood),years=2015,
                   species=c('Pouteria sp.','Inga sp.',
                                            'Eschweillera sp.','Mortoniodendron anisophyllum'))+
  theme(
    axis.title = element_text(size = 12), axis.text.x = element_text(size = 8),
    panel.grid.minor = element_blank()
  ),

ncol=1,labels=c('', '(a)', '', '(b)', '', '(c)'),
rel_heights = c(0.1, 1,0.1, 1, 0.1, 1),label_size=12, vjust = 0)

cowplot::save_plot(
  'Fig_7.pdf', fig_7, nrow = 1, base_height = 21, base_width = 20, units = 'cm'
)

fig_7

```

**Figure 7.**

\pagebreak

```{r environ_vars, echo=FALSE, fig.width=15, fig.height=15, message=FALSE, warning=FALSE}
# Env variables  
env_freq_plot <-
  sfn_env %>%
  dplyr::select(
    si_code, env_ta, env_rh, env_vpd, env_sw_in,env_ppfd_in, env_netrad, env_precip, 
      env_ws
  ) %>%
  gather(Variable, Value, starts_with('env_')) %>%
  mutate(
    n = 1,
    Variable = forcats::fct_relevel(Variable,'env_ta', 'env_rh', 'env_vpd', 'env_sw_in','env_ppfd_in', 
                                   'env_netrad', 'env_precip','env_ws'),
    Value = if_else(Value == 'clearing', 'Clearing', Value),
    Value = forcats::fct_relevel(Value, c('Not provided', 'Off-site', 'Clearing'))
  ) %>%
  ggplot(aes(x = Variable, fill = Value)) +
  geom_bar(stat = 'count', position = 'stack') +
  scale_x_discrete(labels=c('env_ta'='Air temperature\n [env_ta]', 'env_rh'='Relative humidity\n [env_rh]', 
                            'env_vpd'='VPD\n [env_vpd]', 'env_sw_in'='Global radiation\n [env_sw_in]',
                            'env_ppfd_in'='PPFD\n [env_ppfd_in]', 
                                   'env_netrad'='Net radiation\n [env_netrad]', 
                            'env_precip'='Precipitation\n [env_precip]','env_ws'='Wind speed\n [env_ws]'))+
   scale_fill_manual(values=c('lightgrey',viridis::viridis_pal(direction=-1)(4))) +
  #scale_fill_viridis_d() +
  labs(x = '', y = 'Number of datasets',title='') +
  theme_light() +
  theme(
    title=element_text(size=12),
    legend.title = element_blank(),
    legend.position = 'top', legend.direction = 'horizontal',
    legend.key.size = unit(0.70, 'line'),
    legend.text=element_text(size=10),
    axis.text.x = element_text(size=12,angle = 90, hjust = 0.5, vjust = 0.5),
     axis.text.y = element_text(size=12)
  )
  

# Soil 
sfn_swc_freq <-
  sfn_env %>%
  dplyr::select(si_code, env_swc_shallow_depth,env_swc_deep_depth) %>%
  pivot_longer(
    cols = starts_with('env_'),
    names_to = 'depth',
    values_to = 'swc',
    names_prefix = "env_swc_"
  ) %>%
  mutate(
    n=1,
    depth_cat = case_when(
      swc=='Not provided'~'Not provided',
      swc>0 & swc<=15 ~'0-15 cm',
      swc>15 & swc<=30 ~'16-30 cm',
      swc>30 & swc<=70~'31-70 cm',
      swc>70 & swc<=100~'71-100 cm',
      swc >100 ~ '>100 cm'
    ),
    depth_f = fct_relevel(
      as_factor(depth_cat), '0-15 cm', '16-30 cm', '31-70 cm',
      '71-100 cm', '>100 cm'
    ),
    depth_meas = as_factor(depth)
  )

soil_pal<- c(viridis::viridis_pal(direction=-1, option = 'E')(5))

swc_freq_plot <-
  sfn_swc_freq %>%
  filter(depth_cat!='Not provided') %>% 
  ggplot(aes(x=depth_meas,fill=depth_f)) +
  geom_bar(stat='count',position='stack') +
    scale_x_discrete(labels=c('shallow_depth'='SWC shallow\n [swc_shallow_depth]',
                              'deep_depth'='SWC deep\n [swc_deep_depth]'))+
  scale_fill_manual(values=soil_pal) +
  labs(x = '', y = 'Number of datasets', title = '') +
  theme_light() +
  theme(
     title=element_text(size=12),
    legend.title = element_blank(),
    legend.position = c(.73, .75),
    legend.key.size = unit(0.60, 'line'),
    legend.text=element_text(size=8),
    legend.background = element_blank(),
    axis.text.x = element_text(size=12,angle = 90, hjust = 0.5, vjust = 0.5),
     axis.text.y = element_text(size=12)
  )

upper_grid <- cowplot::plot_grid(
  env_freq_plot,swc_freq_plot, 
  label_size = 12, labels=c('(a) Metereological variables', '(b) Soil water content'), rel_widths = c(1, 0.4),vjust=1.2, hjust = -0.05,
  ncol = 2, align = "h", axis = "bt"
)

# Venn diagrams
venn_data <- 
  sfn_env %>%
  dplyr::select(
    si_code, env_netrad, env_ppfd_in, env_precip, env_rh, env_sw_in,
    env_ta, env_vpd, env_ws, env_swc_deep_depth , env_swc_shallow_depth
  ) %>%
  gather(Variable, Value, starts_with('env_')) %>% 
  mutate(n = 1) %>%
  filter(Value != 'Not provided')

venn_list <- list(
  radiation = venn_data %>%
    filter(Variable %in% c('env_netrad', 'env_ppfd_in', 'env_sw_in')) %>%
    pull(si_code) %>%
    unique(),
  ws = venn_data %>%
    filter(Variable == 'env_ws') %>%
    pull(si_code),
  vpd = venn_data %>%
    filter(Variable == 'env_vpd') %>%
    pull(si_code),
  swc = venn_data %>%
    filter(Variable %in% c('env_swc_shallow_depth', 'env_swc_deep_depth')) %>%
    pull(si_code)
)

A <- venn_list[[1]]
B <- venn_list[[2]]
C <- venn_list[[3]]
D <- venn_list[[4]]
list.names <- names(venn_list)
n12 <- intersect(A, B)
n13 <- intersect(A, C)
n14 <- intersect(A, D)
n23 <- intersect(B, C)
n24 <- intersect(B, D)
n34 <- intersect(C, D)
n123 <- intersect(n12, C)
n124 <- intersect(n12, D)
n134 <- intersect(n13, D)
n234 <- intersect(n23, D)
n1234 <- intersect(n123, D)
venn_plot <- VennDiagram::draw.quad.venn(
  area1 = length(A), area2 = length(B), area3 = length(C), area4 = length(D),
  n12 = length(n12), n13 = length(n13), n14 = length(n14), 
  n23 = length(n23), n24 = length(n24), n34 = length(n34), 
  n123 = length(n123), n124 = length(n124), n134 = length(n134), 
  n234 = length(n234), n1234 = length(n1234), 
  ind = FALSE, 
  category = c('Radiation','Wind speed','VPD','SWC'),
  fill = viridis::viridis(4, direction = -1),
  fontfamily = "sans",
  cat.fontfamily = "sans",cat.fontface='bold',
  cex=0.8,
  cat.cex=0.8,
  
)

fig_8 <- cowplot::plot_grid(
  upper_grid, venn_plot,
  nrow = 2, label_size = 12, labels = c('', '(c)'), rel_heights = c(1, 0.5),
  scale = c(1, 0.8), hjust = -5
)

cowplot::save_plot(
  'Fig_8.pdf', fig_8, nrow = 1, base_height = 21, base_width = 20, units = 'cm'
)

fig_8

```
**Figure 8.** 

```{r env_text, include=FALSE, echo=FALSE}

# Values for env variables narrative

 sfn_env %>% 
  dplyr::select(
    si_code, env_ta, env_rh, env_vpd, env_sw_in,env_ppfd_in, env_netrad, env_precip, 
      env_ws
  ) %>% 
 tidyr::pivot_longer(cols=-si_code,names_to='variable',values_to='measurement') %>% 
  group_by(variable,measurement) %>% 
  summarise(n_datasets=n(),
            perc_datasets=n_datasets/202*100) %>% View()

  # vpd overall availbaility
 sfn_env %>% 
  dplyr::select(si_code, env_ta, env_rh, env_vpd) %>% 
   mutate(env_calcvpd = ifelse(env_vpd=='Not provided' & 
                                 env_ta !='Not provided' & 
                                 env_rh!='Not provided', 'Calc_vpd','Not provided'),
          env_vpdall= ifelse(env_vpd!='Not provided' | env_calcvpd!='Not provided',
          'vpd_available','vpd_not_provided')) %>% 
   group_by(env_vpdall) %>% tally()
   
 # radiation overall availability
 
 sfn_env %>% 
  dplyr::select(si_code,env_sw_in,env_ppfd_in,env_netrad) %>% 
   mutate(env_radall = ifelse(env_sw_in!='Not provided' | env_ppfd_in!='Not provided' | env_netrad!='Not provided','rad available','rad unavailable')) %>% 
   group_by(env_radall) %>% tally()
 
 # soil moisture

 sfn_env %>%
  dplyr::select(si_code, env_swc_shallow_depth,env_swc_deep_depth) %>%
  pivot_longer(
    cols = starts_with('env_'),
    names_to = 'depth',
    values_to = 'swc',
    names_prefix = "env_swc_"
  ) %>% 
   group_by(depth) %>% 
   summarise(swc_perc = sum(!is.na(swc))/202)
                
```

\pagebreak

```{r scaling, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=18, fig.width=15}
basa_area_data <-
  dataset_trees_sp %>% 
  mutate(
    sp_basal_area_perc = ifelse(si_code == 'RUS_POG_VAR', NA, sp_basal_area_perc),
    percab_measured = ifelse(si_code == 'RUS_POG_VAR', 0, percab_measured),
    nspecies_fct = case_when(
      nspecies < 2 ~ '1 species',
      between(nspecies, 2, 5) ~ '2-5 species',
      between(nspecies, 6, 10) ~ '6-10 species',
      nspecies > 10 ~ '+10 species',
    ) %>% as_factor %>% fct_relevel('+10 species', after = Inf),
    # nspecies_fct = as_factor(nspecies),
    typeplant = if_else(is.na(typeplant), 'no', typeplant),
    biomes_joined = case_when(
      si_biome %in% c(
        'Subtropical desert', 'Temperate grassland desert','Tropical forest savanna',
        'Temperate rain forest','Tropical rain forest'
      ) ~ 'b) Dry and Tropical',
      si_biome %in% c('Boreal forest','Tundra') ~ 'a) Boreal-Tundra',
      si_biome=='Woodland/Shrubland' ~ 'c) Woodland/Shrubland',
      si_biome=='Temperate forest' ~ 'd) Temperate forest'
    )
  ) %>%
  filter(biomes_joined != 'Unknown') %>%
  arrange(percab_measured)


biomes_plot_list <- basa_area_data %>%
  group_by(biomes_joined) %>%
  group_map(.f = function(data, key) {
    # browser()
    data %>%
      ggplot() +
      geom_bar(
        aes(
          x = fct_reorder(si_code, sp_basal_area_perc, sum, na.rm = TRUE),
          y = sp_basal_area_perc, fill = nspecies_fct, colour = nspecies_fct,
          alpha = typeplant
        ),
        stat = 'identity', show.legend = TRUE
      ) +
      geom_text(
        aes(
          x = fct_reorder(si_code, percab_measured, sum, na.rm = TRUE),
          y = rep(c(115, 125), length.out = data %>% pull(si_code) %>% unique() %>% length()),
          label = total_ntrees
        ),
        size = 4, colour = 'black',
        data = data %>%
          distinct(si_code, .keep_all = TRUE),
        # direction = 'y', seed = 25,
        # min.segment.length = 1000, ylim = c(115, 135),
        show.legend = FALSE
      ) +
      labs(title = key, x = "", y = "") +
      scale_y_continuous(expand = expansion(c(0,0), c(0, 10))) +
      scale_colour_viridis_d(drop = FALSE) +
      scale_fill_viridis_d(drop = FALSE) +
      scale_alpha_manual(values = c(.1, 1), drop = FALSE) +
      guides(
        alpha = 'none', colour = 'none',
        fill = guide_legend('Number of species')
      ) +
      theme_bw() +
      theme(
        title=element_text(size=36),
        legend.text = element_text(size = 12),
        legend.position = "none",
        legend.box = "horizontal",
        legend.title = element_blank(),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(hjust = 0, size = 14),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 14),
        plot.margin = margin(0, 0, 0, 0)
      )
  })

# there is a bug or something I'm doing incorrectly, but the boreal plot
# always has the alpha inverted, so...
biomes_plot_list[[1]] <- biomes_plot_list[[1]] +
  scale_alpha_manual(values = c(1,1))

biomes_grid <- 
  cowplot::plot_grid(
    plotlist = biomes_plot_list,
    nrow = 4, align = 'h'
  )

common_label_y <-
  ggdraw() +
  draw_label(
  "Percentage of stand basal area with sap flow measurements",
 size = 24, angle = 90
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 0)
  )

biomes_grid_common_label <- cowplot::plot_grid(
  common_label_y, biomes_grid, ncol = 2, rel_widths = c(0.03, 1)
)

plot_legend <- get_legend(
  biomes_plot_list[[4]] +
    theme(
      legend.position = "bottom",
      legend.text = element_text(size = 16),
      legend.direction = "horizontal",
      legend.title = element_text(size = 18),
      legend.margin = margin(0,0,0,0)
    )
)

fig_9 <- cowplot::plot_grid(
  biomes_grid_common_label, plot_legend, ncol = 1, rel_heights = c(1, .03)
)

cowplot::save_plot(
  'Fig_9.tiff', fig_9, nrow = 1, base_height = 11.7, base_width = 8.3
)

fig_9

```
**Figure 9.** 

\pagebreak

```{r table_treatments, echo=FALSE, results='asis', message=FALSE, warning=FALSE}

read_csv('resources/treatment_table.csv') %>% 
   qflextable() %>%  
  bold( i = 1,  part = "header") %>%
    fontsize(size=10,part='body') %>% 
  flextable::set_header_labels(
    st_treatment='Treatment',
                    n_sites='N sites',
                    n_plants='N plants',
                    n_species='N species') %>% 
  align(part='header',align='left') %>% 
   set_caption('Table 3')

```

