---
title: "SAPFLUXNET: Global transpiration data from sap flow measurements"
subtitle: 'Figures and tables'
author: "R. Poyatos"
date: "24/03/2020"
output:
  word_document: 
    reference_docx: word-styles-reference-01.docx
  html_document:
    df_print: paged
  pdf_document: 
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sapfluxnetr)
library(purrr)
library(flextable)
library(pander)
library(magrittr)
library(ggplot2)
library(ggalluvial)
library(ggrepel)
library(ggbiome)
library(cowplot)
library(ggspatial)
library(raster)
library(VennDiagram)

source('R/sfn_datapaper_functions.R')
source('metadata_wrangling.R')
load('maps_base.RData')

```

## Figure captions

**Figure 1.** Overview of the SAPFLUXNET data workflow. Data files are received 
from data contributors, and undergo several quality control processes (QC1 and QC2). 
Both, QC1 and QC2 produce an .RData object of the custom-designed sfn-data S4 class 
storing all data, metadata and data flags for each dataset. The progress and results of the QC  
processes are monitored through individual reports and log files. The final outcome, 
is stored in a folder structure with a either single .RData file for each dataset or a
set of seven csv files for each dataset.

**Figure 2.** (a) Geographic, (b) bioclimatic and (c) vegetation type distribution 
of SAPFLUXNET datasets. In (b) we represent the different datasets according to their 
mean annual temperature and precipitaion in a Whittaker diagram showing the classification
of the main terrestrial biomes.

**Figure 3.** Taxonomic distribution of genera and species in SAPFLUXNET, showing 
(a) genera with > 50 trees and (b) species with > 30 trees in the database.

**Figure 4.** Distribution of trees in SAPFLUXNET according to taxonomic group, sap flow method 
and measurement level.

**Table 1.** Calibrations

**Table 2.** Whole-plant integration of sap flow data.

**Figure 5.** Ecological representativity of SAPFLUXNET plants and stands. 
Panel (a) shows the distribution of plants according to their taxonomic group
(angiosperms, gymnosperms) and their main individual attributes: 
diameter at breast height (DBH) plant height, sapwood area, sapwood 
depth and leaf area. Panel (b) shows the distribution of SAPFLUXNET stands 
according to their main attributes: stand age, stand height, stem density, 
stand basal area,leaf area index (LAI) and soil depth.

**Figure 6.** (a) Duration of SAPFLUXNET datasets rxpressed in number days with sap 
flow data and coloured by the number of trees measured. The 30 longest datasets
are labelled. For each dataset in panel (a), panel (b) shows its corresponding 
measurement period.

**Figure 7.** Fingerprint plots showing hourly sap flux density (colour scale) 
as a function of hour of day (x-axis) and day of year (y-axis) for a selection 
of SAPFLUXNET sites with at least four co-occurring species.
Panel (a) shows data from a Mediterranean forest in NE Spain (ESP_CAN), 
for an average (2011) and a dry (2012) year. Panel (b) shows data for a mesic 
Temperate forest (USA_???) and panel (c) shows data for a Tropical
forest (CRI_TAM_TOW). 

**Figure 8.** Summary of the availability of different environmental variables in
SAPFLUXNET datasets. (a) Distribution of environmental variables according to the 
measurement location. (b) Distribution of soil moisture variables according to the
measurement depth. (c) Venn diagram showing the degree of overlap amongst the 
availability of different environmental variables across SAPFLUXNET datasets.

**Figure 9.** Potential for upscaling individual tree sap flow to stand-level sap flow
using SAPFLUXNET datasets, classified using an aggregated biome classification. 
Each panel shows the percentage of total stand basal area that is covered by
sap flow measurements for each species in the dataset. Datasets are also coloured
by the number of species present. Blue numbers on top of each bar depict the total
number of trees for a given dataset. Empty bars show datasets for which plant-level
data are not available.

\pagebreak

```{r data_workflow, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE,fig.align='center'}
knitr::include_graphics('resources/QC_process.svg')
```

**Figure 1.**

\pagebreak

```{r sitesmap, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=15, fig.width=15}
sitesmap_global <- globforest_rec_0_1  +
  geom_point(data=sfn_allsites,aes(x=si_long,y=si_lat),shape=21,color='black',fill='royalblue',alpha=0.5)+
  guides(fill='none')+xlab(NULL)+ylab(NULL)+
  theme_light()+
  theme(axis.title=element_text(size=18),axis.text=element_text(size=18))

# TODO: preliminary filtering out climatic NAs
# Use CHELSA to gf 

biomes_plot <- sfn_allsites %>%
  dplyr::arrange(si_biome) %>%
  dplyr::filter(!is.na(si_map) | !is.na(si_map)) %>% 
  ggbiome::vis_location_biome(si_lat='si_lat',
                              si_long='si_long',si_mat='si_mat',si_map='si_map') +
  
  theme(
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    title= element_text(size=20),
    axis.title=element_text(size=20),
    axis.text=element_text(size=20),
    legend.title = element_blank(),
    legend.text = element_text(size =16),
    legend.key.size = unit(1.5, 'line'),
    legend.position = c(0.7,0.2)
    
  )

igbp_plot<-sfn_allsites %>% 
  group_by(si_igbp) %>% 
  tally() %>% 
  ggplot(.,aes(y=n,x=reorder(si_igbp,desc(n))))+
  geom_bar(stat='identity')+
  xlab('Vegetation type')+ylab('Number of datasets')+
  theme_light()+
  theme(axis.title=element_text(size=18),axis.text=element_text(size=18))

# Build figure 
cowplot::plot_grid(
  # row 1
  cowplot::plot_grid(sitesmap_global, labels='(a)'),
  # row 2
  cowplot::plot_grid(biomes_plot, igbp_plot,labels=c('(b)','(c)'),rel_widths=c(0.6,0.4)),
  ncol=1, label_size=16, rel_heights=c(0.6,0.4))

```

**Figure 2.** 

\pagebreak

```{r genera_species, message=FALSE, warning=FALSE,fig.height=15, fig.width=12, echo=FALSE}

sfn_sitespecies_tax %>%
  group_by(genus,si_code) %>%
  summarise(n_si = sum(sp_ntrees)) %>% 
  group_by(genus) %>% 
  mutate(
    n_all = sum(n_si),
    vjust = n_si/sum(n_si),
    fill_dummy = if_else(n_si > 14, si_code, 'zz_other')
  ) %>%
  filter(n_all>50) %>%
  arrange(desc(n_si)) %>%
  mutate(
    accumulated = cumsum(n_si),
    segment_start = accumulated - (n_si/2)
  ) -> ntrees_species_top_data

ntrees_species_top_data %>%
  # only show label for those sites in each genus with 15 trees or more
  filter(n_si > 14) -> ntrees_species_top_data_labels

number_sites_labels <-
  ntrees_species_top_data %>%
  count() %>%
  mutate(x_label = paste0(n, ' sites'), y = 800) %>%
  left_join(
    ntrees_species_top_data %>%
      dplyr::select(genus, n_all) %>%
      distinct()
  )

ntrees_species_top <-
  ntrees_species_top_data %>% 
  ggplot(aes(x = reorder(genus, n_all), y = n_si, fill = reorder(fill_dummy, n_si))) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  geom_text(
    aes(label = x_label, y = y, x = reorder(genus, n_all)),
    data = number_sites_labels, inherit.aes = FALSE
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Pinus'),
    # position = 'identity',
    size = 2,
    # repel options
    nudge_x = 2.2,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Quercus'),
    # position = 'identity',
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 320 + ntrees_species_top_data_labels %>% filter(genus == 'Quercus') %>% pull(segment_start),
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Acer'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 190,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Picea'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 420,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Eucalyptus'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 210,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Fagus'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 280,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Populus'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 100,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Abies'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 60,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n_si})"), y = segment_start),
    data = ntrees_species_top_data_labels %>% filter(genus == 'Acacia'),
    size = 2,
    # repel options
    nudge_x = 0.5,
    nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  scale_fill_manual(values = c('grey', viridis::viridis(30))) +
  scale_y_continuous(expand = expand_scale(c(0,0), c(0,100))) +
  scale_x_discrete(expand = expand_scale(c(0,0), c(1,2.5))) +
  # viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of trees',
       title = 'Genera with > 50 trees') +
  # coord_flip() +
  theme_bw() +
  theme(
    title= element_text(size = 14),
    axis.title=element_text(size = 14),
    axis.text=element_text(size = 14),
    axis.text.x=element_text(face='italic', angle = 30, vjust = 0.9, hjust = 0.8),
    legend.title = element_blank(),
    legend.position = 'none'
  )

# species plot
sfn_sitespecies_tax%>%
  filter(!is.na(sp_ntrees)) %>% 
  group_by(sp_name, si_code) %>%
  summarise(n = sum(sp_ntrees)) %>%
  group_by(sp_name) %>% 
  mutate(
    n_all=sum(n),
    vjust = n/sum(n),
    fill_dummy = if_else(n > 14, si_code, 'zz_other')
  ) %>% 
  filter(n_all>50) %>%
  arrange(desc(n)) %>%
  mutate(
    accumulated = cumsum(n),
    segment_start = accumulated - (n/2)
  ) -> ntrees_genus_top_data

ntrees_genus_top_data %>%
  # only show label for those sites in each genus with 15 trees or more
  filter(n > 14) -> ntrees_genus_top_data_labels

number_sites_labels_genus <-
  ntrees_genus_top_data %>%
  count() %>%
  mutate(x_label = paste0(n, ' sites'), y = 330) %>%
  left_join(
    ntrees_genus_top_data %>%
      dplyr::select(sp_name, n_all) %>%
      distinct()
  )

ntrees_genus_top <- 
  ntrees_genus_top_data %>% 
  ggplot(aes(x = reorder(sp_name, n_all), y = n, fill = reorder(fill_dummy, n))) +
  geom_bar(stat = 'identity', show.legend = FALSE) +
  geom_text(
    aes(label = x_label, y = y, x = reorder(sp_name, n_all)),
    data = number_sites_labels_genus, inherit.aes = FALSE
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus sylvestris'),
    size = 2,
    # repel options
    nudge_x = 2.2,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Picea abies'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 190,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Acer saccharum'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = c(125, 50),
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus taeda'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Populus tremuloides'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus koraiensis'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = c(140, 100, 60),
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Pinus strobus'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 75,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  geom_text_repel(
    aes(label = glue::glue("{si_code} ({n})"), y = segment_start),
    data = ntrees_genus_top_data_labels %>% filter(sp_name == 'Acer rubrum'),
    size = 2,
    # repel options
    nudge_x = 0.5, nudge_y = 60,
    hjust = 1,
    direction = 'y', min.segment.length = 1000
  ) +
  scale_fill_manual(values = c('grey', viridis::viridis(19))) +
  scale_y_continuous(expand = expand_scale(c(0,0), c(0,50))) +
  scale_x_discrete(expand = expand_scale(c(0,0), c(1,2.5))) +
  # viridis::scale_fill_viridis(discrete = TRUE) +
  labs(x = '', y = 'Number of trees', 
       title = 'Species with >50 trees') +
  # coord_flip() +
  theme_bw() +
  theme(
    title= element_text(size = 14),
    axis.title=element_text(size = 14),
    axis.text=element_text(size = 14),
    axis.text.x=element_text(face='italic', angle = 30, vjust = 0.9, hjust = 0.8),
    legend.title = element_blank(),
    legend.position = 'none'
  )

cowplot::plot_grid(ntrees_genus_top,ntrees_species_top,
                   label_size= 14,labels=c('a)', 'b)'),ncol=1, nrow=2, align = "v", axis = "b")
```
**Figure 3.** 

\pagebreak

```{r method_type,fig.height=15, fig.width=15, echo=FALSE}

ggplot(sfn_plants_type,
       aes(y = n, axis2 = pl_sens_meth, axis3= typef,axis1=group)) +
  geom_alluvium(aes(fill = group), width = 1/12)+
  geom_stratum(width = 1/12, alpha = .5) +
  geom_label_repel(stat = "stratum", infer.label = TRUE,size=10) +
  scale_x_discrete(limits = c("Group","Sap flow method","Level"), 
                   expand = c(.05, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1")+
  scale_fill_viridis_d()+
  ylab('Number of trees')+
  theme_minimal()+
  theme(legend.position = "none", axis.title=element_text(size=24),
        axis.text = element_text(size=24))
  
```
**Figure 4.** 

\pagebreak


```{r table_calib, echo=FALSE}
sfn_allplants_tax %>% 
  group_by(pl_sens_meth) %>% 
  summarise(
    n_cal=sum(pl_sens_calib,na.rm=TRUE),
    n_noncal=sum(!pl_sens_calib,na.rm=TRUE),
    n_notprov=sum(is.na(pl_sens_calib),na.rm=TRUE),
    perc_calib = round(n_cal/(n_noncal+n_notprov)*100,1)) %>% 
  flextable() %>% 
  set_header_labels(
    pl_sens_meth='Method',
    n_cal='Calibrated',
    n_noncal='Non-calibrated',
    n_notprov='Not provided',
    perc_calib='% calibrated'
  ) %>% 
   set_caption('Table 1. Number of sap flow times series in SAPFLUXNET with species-specific calibrated data') %>% 
  autofit()

```

\pagebreak

```{r spatial_integration, echo=FALSE}

# Spatial integration of sap flow
left_join(
  #table  1 calibrations
  sfn_allplants_tax %>% 
    group_by(pl_sens_meth,pl_radial_int) %>% 
    tally()  %>% 
    pivot_wider(names_from='pl_radial_int',
                values_from='n',
                values_fill=list(n=0)) %>% 
    rename('Not provided'='NA'), # next table
 #table 2 integration
 sfn_allplants_tax %>% 
   group_by(pl_sens_meth,pl_azimut_int) %>% 
   tally()  %>% 
   pivot_wider(names_from='pl_azimut_int',
               values_from='n',
               values_fill=list(n=0)),
 by='pl_sens_meth') %>% 
  rename('Method' ='pl_sens_meth','N.provided'='NA') %>% 
  flextable(col_keys=c(
    'Method','Measured','Sensor-integrated','Corrected, measured radial variation',
    'No radial correction','Not provided',
     'measured','sensor_integrated','Corrected, measured azimuthal variation',
    'No azimuthal correction','N.provided')) %>% 
  set_header_labels(
    'measured'='Measured',
    'sensor_integrated'='Sensor-integrated',
    'N.provided'='Not provided'
  ) %>% 
  add_header_row(values=c('','Radial correction','Azimuthal correction'),colwidths=c(1,5,5)) %>% 
  align(i=1:8,align='right') %>% 
  bold(i=1,part='header') %>% 
  fontsize(size=10) %>% 
    fontsize(size=10,part='header') %>% 
  height(i=2,height=1,part='header') %>% 
  width(j=1,width=0.65) %>% 
  width(j=2:11,width=0.75) %>% 
  empty_blanks() %>% 
   set_caption('Table 2. Number of trees using different radial and azimuthal integration approaches, for 
               the different sap flow methods')



```



\pagebreak

```{r stand_plant_attributes, echo=FALSE, message=FALSE, warning=FALSE, fig.height=15, fig.width=18}

##########################################################################################
#
# Split violin plot code taken from here:
# https://stackoverflow.com/questions/35717353/split-violin-plot-with-ggplot2
#
GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, 
                           draw_group = function(self, data, ..., draw_quantiles = NULL) {
  data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
  grp <- data[1, "group"]
  newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
  newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
  newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])

  if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
    stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <=
      1))
    quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
    aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
    aesthetics$alpha <- rep(1, nrow(quantiles))
    both <- cbind(quantiles, aesthetics)
    quantile_grob <- GeomPath$draw_panel(both, ...)
    ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
  }
  else {
    ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
  }
})

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, 
        position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}
##########################################################################################

# Stand attributes --------------------------------------------------------

sfn_allstands_long <- 
  sfn_allstands %>%
  dplyr::select(
    si_code, st_age, st_height, st_density, st_basal_area, st_lai, st_soil_depth
  ) %>%
  pivot_longer(names_to = "Var", values_to = "Value", cols=st_age:st_soil_depth) %>%
  mutate(
    Varf = forcats::as_factor(Var) %>% forcats::fct_relabel(
      ~ c(
        'Age~(years)','Height~(m)','Stem~density~(stems~ha^{"-1"})',
        'Basal~area~(m^2~ha^{"-1"})','LAI~(m^2~m^{"-2"})','Soil~depth~(m)'
      )
    )
  )

stand_violins <-
  sfn_allstands_long %>% 
  ggplot(.,aes(x = Var, y = Value)) +
  geom_violin(fill = viridis::viridis(1, begin = 0.5), alpha = 0.3) +
  geom_point(colour = viridis::viridis(1, begin = 0.5),alpha = 0.5,
             position = position_jitter(width = 0.2, height = 0)) +
  facet_wrap(~Varf,scales = 'free', labeller = label_parsed) +
  guides(fill = FALSE) +
  labs(x = NULL, y = NULL) +
  theme_light() +
  theme(axis.text.x = element_blank(),axis.text.y = element_text(size = 16),
        strip.background = element_rect(fill = 'white', colour = 'darkgray'),
        strip.text = element_text(size = 16, colour = 'black', face = 'bold'))

#  Plant attributes -------------------------------------------------------

sfn_allplants_long <-
  sfn_allplants_tax %>%
  dplyr::select(
    pl_code, pl_dbh, pl_height, pl_sapw_area, pl_sapw_depth, pl_leaf_area, group
  ) %>% 
  pivot_longer(names_to = "Var", values_to = "Value", cols = pl_dbh:pl_leaf_area) %>% 
  mutate(
    Varf = forcats::as_factor(Var) %>% forcats::fct_relabel(
      ~ c(
        'DBH~(cm)', 'Height~(m)', 'Sapwood~area~(cm^2)',
        'Sapwood~depth~(cm)', 'Leaf~area(m^2)'
      )
    )
  )

plant_violins <-
  sfn_allplants_long %>% 
  ggplot(aes(x = Var, y = Value, fill = group)) +
  geom_split_violin(alpha = 0.5) +
  # data points angios
  geom_point(
    aes(x = 0.75),
    data = sfn_allplants_long %>%
      filter(group == 'Angiosperms'),
    colour = viridis::viridis(1), alpha=0.2,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # median point angios
  geom_errorbarh(
    data = sfn_allplants_long %>%
        filter(group == 'Angiosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(xmin = 0.95, xmax = 1.05, y = median, fill = NA, height = 0),
    colour = 'white', size = 0.8,
    position = position_nudge(x = -0.03)
  ) +
  geom_point(
    data = sfn_allplants_long %>%
        filter(group == 'Angiosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = Var, y = median),
    colour = 'white', size = 3, shape = 23, fill = viridis::viridis(1),
    position = position_nudge(x = -0.03)
  ) +
  # data points gymnos
  geom_point(
    aes(x = 1.25),
    data = sfn_allplants_long %>%
      filter(group == 'Gymnosperms'),
    colour = viridis::viridis(1, direction = -1), alpha=0.2,
    position = position_jitter(width = 0.1, height = 0, seed = 25),
    show.legend = FALSE
  ) +
  # median point gymnos
  geom_errorbarh(
    data = sfn_allplants_long %>%
        filter(group == 'Gymnosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(xmin = 0.95, xmax = 1.05, y = median, fill = NA, height = 0),
    colour = 'black', size = 0.8,
    position = position_nudge(x = 0.03)
  ) +
  geom_point(
    data = sfn_allplants_long %>%
        filter(group == 'Gymnosperms') %>%
        group_by(Var, Varf) %>%
        summarise(median = median(Value, na.rm = TRUE)),
    aes(x = Var, y = median),
    colour = 'black', size = 3,
    shape = 23, fill = viridis::viridis(1, direction = -1),
    position = position_nudge(x = 0.03)
  ) +
  facet_wrap(~Varf,scales='free',labeller=label_parsed) +
  scale_fill_viridis_d() +
  labs(x=NULL,y=NULL)+
  theme_light() +
  guides(fill = guide_legend(title = 'Functional group')) +
  theme(
    axis.text.x = element_blank(), axis.text.y = element_text(size = 16),
    strip.background = element_rect(fill = 'white', colour='darkgray'),
    strip.text = element_text(size = 16, colour = 'black', face = 'bold'),
    legend.position = c(0.85, 0.25), legend.text = element_text(size = 14),
    legend.title = element_text(size = 15, face = 'bold')
  )

cowplot::plot_grid(
  NULL, plant_violins, NULL, stand_violins,
  labels = c('(a) Plant attributes', NA,  '(b) Stand attributes', NA),
  rel_widths = c(1,1,1,1), nrow = 4, rel_heights = c(0.1, 1, 0.1, 1),
  label_size = 16
)

```
**Figure 5.** 


```{r attributes_text, include=FALSE}

sfn_allplants_tax %>% 
  dplyr::select(pl_dbh,pl_height,pl_age,pl_sapw_area,pl_sapw_depth) %>% 
 map_df(~sum(is.na(.))/length(.)*100)


sfn_allplants_tax %>% 
  mutate(rank_dbh = dense_rank(desc(pl_dbh)),
         rank_sapw_area =dense_rank(desc(pl_sapw_area)),
         rank_sap_depth=dense_rank(desc(pl_sapw_depth)),
         rank_leaf_area=dense_rank(desc(pl_leaf_area))) %>% 
  arrange(rank_sapw_area) %>% 
  dplyr::select(si_code,pl_species,pl_dbh,pl_sapw_area,pl_sapw_depth,starts_with('rank')) 
  

sfn_allstands  %>% 
  dplyr::select(si_code,st_lai,st_density,st_basal_area,st_height,st_soil_depth) %>% 
 map_df(~sum(is.na(.))/length(.)*100)


sfn_allstands %>% 
  mutate(
    rank_lai= dense_rank(desc(st_lai)),
    rank_age=dense_rank(desc(st_age)),
    rank_density=dense_rank(desc(st_density)),
    rank_abasal=dense_rank(desc(st_basal_area)),
    rank_height=dense_rank(desc(st_height)),
    rank_soild=dense_rank(desc(st_soil_depth)) 
  ) %>% arrange(rank_abasal) %>% 
  dplyr::select(si_code,st_lai,st_density,st_basal_area,st_height,st_soil_depth,
                starts_with('rank')) 


sfn_allstands %>% 
dplyr::select(si_code,st_lai,st_density,st_age,st_basal_area,st_height,st_soil_depth) %>% 
  summarise_all(median,na.rm=TRUE)
  


```

\pagebreak

```{r dataset_duration, echo=FALSE, fig.height=18, fig.width=15, message=FALSE, warning=FALSE, cache=TRUE}
# Load data
load('dataset_duration_data.RData')

# Figure showing dataset duration and n_trees
# Palette for dataset duration plot
treeclass_pal<- c(viridis::viridis_pal(direction = 1, begin = 0.1)(7))

datasets_duration %>%
      dplyr::filter(n_trees > 0) %>%
      dplyr::mutate(index_days = seq_along(n)) %>%
      dplyr::select(si_code, index_days) %>%
      dplyr::summarise(max_days = max(index_days)) %>%
      dplyr::arrange(desc(max_days)) %>%
      dplyr::slice(1:30) -> datasets_duration_top30

data_duration_plot <-
  datasets_duration %>%
  filter(n_trees > 0) %>%
  mutate(index_days = seq_along(n)) %>%
  ggplot(
    aes(x = index_days, y = reorder(si_code, index_days, max), fill = n_trees_class_f)
  ) +
  geom_tile() +
  geom_label_repel(
    data = datasets_duration_top30,
    aes(x = max_days, y = reorder(si_code, max_days), label = si_code),
    inherit.aes = FALSE,
    hjust = 0,
    direction = 'y',
    # xlim = c(2000, NA),
    nudge_x = c(
      4000 - datasets_duration_top30$max_days[1:25],
      2500 - datasets_duration_top30$max_days[26:30]
    ),
    nudge_y = c(
      (202 - seq(198, 2, length.out = 30))[1:25] * -1,
      (202 - seq(198, 2, length.out = 30))[21:25] * -1
    ),
    force = 0,
    seed = 25
  ) +
  scale_fill_manual(values = treeclass_pal) +
  scale_x_continuous(expand = expand_scale(c(0,0), c(0, 20))) +
  labs(y = '', x = 'Number of days', fill = 'Number of trees') +
  theme_light() +
  theme(
    axis.title.x = element_text(size = 14), axis.text.x = element_text(size = 12),
    axis.text.y = element_blank(),
    legend.position = c(.2, .2), legend.text = element_text(size = 14),
    legend.title = element_text(size = 15, face = 'bold')
  )
    
  
data_period_plot <-
  datasets_duration %>%
  filter(n_trees > 0) %>%
  mutate(index_days = seq_along(n)) %>%
  ggplot(aes(x = TIMESTAMP2, y = reorder(si_code, index_days, max))) +
  geom_tile(fill = treeclass_pal[1]) +
  theme_light() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  guides(fill = 'none') +
  labs(x = "",y = 'Year') +
  theme(axis.title.x = element_text(size = 14), axis.text.x = element_text(size = 12))

# Figure composition

duration_plot_composed <- cowplot::plot_grid(
  data_duration_plot, data_period_plot,
  labels = c('(a)','(b)'), rel_widths = c(1,0.4)
)
duration_plot_composed

```

**Figure 6.**

\pagebreak

```{r fingerprint_plots, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.height=18, fig.width=15}

# Functions
source('R/sfn_datapaper_functions.R')

# Data path
path.sapwood <- file.path('data/0.1.4/RData/sapwood')

# Plot
cowplot::plot_grid(
sfn_finger_species(read_sfn_data('ESP_CAN',folder=path.sapwood)),
sfn_finger_species(read_sfn_data('USA_WVF',folder=path.sapwood),years=1998,
                   species=c('Acer saccharum','Prunus serotina','Quercus alba','Quercus rubra')),

sfn_finger_species(read_sfn_data('CRI_TAM_TOW',folder=path.sapwood),years=2015,
                   species=c('Pouteria sp.','Inga sp.',
                                            'Eschweillera sp.','Mortoniodendron anisophyllum')),
ncol=1,labels=c('a)','b)','c)'),rel_heights = c(1,1,1))

```

**Figure 7.**

\pagebreak

```{r environ_vars, echo=FALSE, fig.width=15, fig.height=15, message=FALSE, warning=FALSE}
# Env variables  
env_freq_plot <-
  sfn_env %>%
  dplyr::select(
    si_code, env_netrad, env_ppfd_in, env_precip, env_rh,
    env_sw_in, env_ta, env_vpd, env_ws
  ) %>%
  gather(Variable, Value, starts_with('env_')) %>%
  mutate(
    n = 1,
    Value = if_else(Value == 'clearing', 'Clearing', Value),
    Value = forcats::fct_relevel(Value, c('Not provided', 'Off-site', 'Clearing'))
  ) %>%
  ggplot(aes(x = Variable, fill = Value)) +
  geom_bar(stat = 'count', position = 'stack') +
  scale_fill_viridis_d() +
  labs(x = '', y = 'Number of sites') +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = 'top', legend.direction = 'horizontal',
    axis.text.x = element_text(angle = 90)
  )
  

# Soil 
sfn_swc_freq <-
  sfn_env %>%
  dplyr::select(si_code, env_swc_shallow_depth,env_swc_deep_depth) %>%
  pivot_longer(
    cols = starts_with('env_'),
    names_to = 'depth',
    values_to = 'swc',
    names_prefix = "env_swc_"
  ) %>%
  mutate(
    n=1,
    depth_cat = case_when(
      swc=='Not provided'~'Not provided',
      swc>0 & swc<=15 ~'0-15 cm',
      swc>15 & swc<=30 ~'16-30 cm',
      swc>30 & swc<=70~'31-70 cm',
      swc>70 & swc<=100~'71-100 cm',
      swc >100 ~ '>100 cm'
    ),
    depth_f = as_factor(depth_cat),
    depth_meas = as_factor(depth)
  )

soil_pal<- c('lightgrey',viridis::viridis_pal(direction=-1)(4))

swc_freq_plot <-
  sfn_swc_freq %>%
  filter(depth_cat!='Not provided') %>% 
  ggplot(aes(x=depth_meas,fill=depth_cat)) +
  geom_bar(stat='count',position='stack') +
  scale_fill_manual(values=soil_pal) +
  labs(x = '', y = 'Number of sites', title = 'Soil water content') +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = c(.8, .8),
    axis.text.x = element_text(angle = 90)
  )

upper_grid <- cowplot::plot_grid(
  env_freq_plot,swc_freq_plot, 
  label_size = 16, labels=c('a)', 'b)'), rel_widths = c(1, 0.4),
  ncol = 2, align = "h", axis = "b"
)

# Venn diagrams
venn_data <- 
  sfn_env %>%
  dplyr::select(
    si_code, env_netrad, env_ppfd_in, env_precip, env_rh, env_sw_in,
    env_ta, env_vpd, env_ws, env_swc_deep_depth , env_swc_shallow_depth
  ) %>%
  gather(Variable, Value, starts_with('env_')) %>% 
  mutate(n = 1) %>%
  filter(Value != 'Not provided')

venn_list <- list(
  radiation = venn_data %>%
    filter(Variable %in% c('env_netrad', 'env_ppfd_in', 'env_sw_in')) %>%
    pull(si_code) %>%
    unique(),
  ws = venn_data %>%
    filter(Variable == 'env_ws') %>%
    pull(si_code),
  vpd = venn_data %>%
    filter(Variable == 'env_vpd') %>%
    pull(si_code),
  swc = venn_data %>%
    filter(Variable %in% c('env_swc_shallow_depth', 'env_swc_deep_depth')) %>%
    pull(si_code)
)

A <- venn_list[[1]]
B <- venn_list[[2]]
C <- venn_list[[3]]
D <- venn_list[[4]]
list.names <- names(venn_list)
n12 <- intersect(A, B)
n13 <- intersect(A, C)
n14 <- intersect(A, D)
n23 <- intersect(B, C)
n24 <- intersect(B, D)
n34 <- intersect(C, D)
n123 <- intersect(n12, C)
n124 <- intersect(n12, D)
n134 <- intersect(n13, D)
n234 <- intersect(n23, D)
n1234 <- intersect(n123, D)
venn_plot <- VennDiagram::draw.quad.venn(
  area1 = length(A), area2 = length(B), area3 = length(C), area4 = length(D),
  n12 = length(n12), n13 = length(n13), n14 = length(n14), 
  n23 = length(n23), n24 = length(n24), n34 = length(n34), 
  n123 = length(n123), n124 = length(n124), n134 = length(n134), 
  n234 = length(n234), n1234 = length(n1234), 
  ind = FALSE, category = list.names,
  fill = viridis::viridis(4, direction = -1)
)

cowplot::plot_grid(
  upper_grid, venn_plot,
  nrow = 2, label_size = 16, labels = c('', 'c)')
)

```
**Figure 8.** 

\pagebreak

```{r scaling, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=18, fig.width=15}
basa_area_data <-
  dataset_trees_sp %>% 
  mutate(
    sp_basal_area_perc = ifelse(si_code == 'RUS_POG_VAR', NA, sp_basal_area_perc),
    percab_measured = ifelse(si_code == 'RUS_POG_VAR', 0, percab_measured),
    nspecies_fct = as_factor(nspecies),
    typeplant = if_else(is.na(typeplant), 'no', typeplant),
    biomes_joined = case_when(
      si_biome %in% c(
        'Subtropical desert', 'Temperate grassland desert','Tropical forest savanna',
        'Temperate rain forest','Tropical rain forest'
      ) ~ 'Dry-Tropical',
      si_biome %in% c('Boreal forest','Tundra') ~ 'Boreal-Tundra',
      TRUE ~ si_biome
    )
  ) %>%
  filter(biomes_joined != 'Unknown')

biomes_plot_list <- basa_area_data %>%
  group_by(biomes_joined) %>%
  group_map(.f = function(data, key) {
    data %>%
      ggplot() +
      geom_bar(
        aes(
          x = fct_reorder(si_code, sp_basal_area_perc, sum, na.rm = TRUE),
          y = sp_basal_area_perc, fill = nspecies_fct, colour = nspecies_fct,
          alpha = typeplant
        ),
        stat = 'identity', show.legend = TRUE
      ) +
      geom_text(
        aes(
          x = fct_reorder(si_code, percab_measured, sum, na.rm = TRUE),
          y = 125,
          label = total_ntrees
        ),
        size = 3, colour = 'blue',
        data = data %>%
          distinct(si_code, .keep_all = TRUE),
        show.legend = FALSE
      ) +
      labs(title = key, x = "", y = "") +
      scale_y_continuous(expand = expand_scale(c(0,0), c(0, 10))) +
      scale_colour_viridis_d(drop = FALSE) +
      scale_fill_viridis_d(drop = FALSE) +
      scale_alpha_manual(values = c(.1, 1), drop = FALSE) +
      guides(
        alpha = 'none', colour = 'none',
        fill = guide_legend('Number of species')
      ) +
      theme_bw() +
      theme(
        legend.text = element_text(size = 12),
        legend.position = "none",
        legend.box = "horizontal",
        legend.title = element_blank(),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(hjust = 0, size = 14),
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.margin = margin(0, 0, 0, 0)
      )
  })

# there is a bug or something I'm doing incorrectly, but the boreal plot
# always has the alpha inverted, so...
biomes_plot_list[[1]] <- biomes_plot_list[[1]] +
  scale_alpha_manual(values = c(1,1))

biomes_grid <- 
  cowplot::plot_grid(
    plotlist = biomes_plot_list,
    nrow = 4, align = 'h'
  )

common_label_y <-
  ggdraw() +
  draw_label(
  "% of basal area measured with sap flow",
  fontface = 'bold', size = 20, angle = 90
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 0)
  )

biomes_grid_common_label <- cowplot::plot_grid(
  common_label_y, biomes_grid, ncol = 2, rel_widths = c(0.03, 1)
)

plot_legend <- get_legend(
  biomes_plot_list[[4]] +
    theme(
      legend.position = "right",
      legend.text = element_text(size = 12),
      legend.direction = "vertical",
      legend.title = element_text(size = 12),
      legend.margin = margin(0,0,0,0)
    )
)

cowplot::plot_grid(
  biomes_grid_common_label, plot_legend, ncol = 2, rel_widths = c(1, .2)
)

```
**Figure 9.** 

```{r table_treatments, echo=FALSE, results='asis', message=FALSE, warning=FALSE}

read_csv('resources/treatment_table.csv') %>% 
   qflextable() %>%  
  bold( i = 1,  part = "header") %>%
    fontsize(size=10,part='body') %>% 
  flextable::set_header_labels(
    st_treatment='Treatment',
                    n_sites='N sites',
                    n_plants='N plants',
                    n_species='N species') %>% 
  align(part='header',align='left') %>% 
   set_caption('Table 3. Treatments')

```

