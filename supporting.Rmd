---
title: "Tables for SAPFLUXNET data paper"
author: "R. Poyatos"
date: "9th January 2020"
output:
  pdf_document: default
  word_document: 
    reference_docx: word-styles-reference-01.docx
  html_document:
    df_print: paged
---

## Contents

### Figure S1. 
QC overview, showing file management, identifying automatic and manual steps and 
indicating status file updates.
### Table S1. Quality control of metadata in the QC1 stage.
### Figure S2. Structure of sfn_data objects.
### Table S2. Metadata variables of SAPFLUXNET datasets.
### Table S3. Quality control of metadata in the QC2 stage.
### Figure S3. 
Example of the interactive application for outlier and and out of range detection in
the QC2 stage.
### Table. Datasets
### Table. Number of trees per genus
### Table. Number of trees per species

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(flextable)
library(pander)
library(magrittr)
library(readxl)
library(tidyverse)
source('metadata_wrangling.R')
```

\pagebreak

## Supplementary 

\pagebreak

```{r fig_QC, echo=FALSE,  out.height="800px",fig.align='center', fig.cap='Figure X. Overview of the data QC process'}

knitr::include_graphics('resources/QC_summary2.svg')
```

\pagebreak

```{r table_QC1, echo=FALSE,results='asis'}

readxl::read_xlsx('resources/table_QC1_checks.xlsx',1) %>% 
   qflextable() %>%  
  bold( i = 1,  part = "header") %>%
   set_caption('Table X. QC1 data checks') %>% 
  width(width=c(1.8,5)) %>%
  height(height=.7)
```
\pagebreak

```{r fig_sfn_data, echo=FALSE,  out.height="800px",fig.align='center', fig.cap='Figure X. Overview of the data QC process'}

knitr::include_graphics('resources/schematics.svg')
```


\pagebreak


```{r tab_metadatavars, echo=FALSE, results='asis'}

site_md_table <- sapfluxnetr:::.metadata_architecture() %>%
  magrittr::extract2(., 'site_md') %>%
  purrr::map_dfr(magrittr::extract, c('description', 'type', 'units')) %>%
  dplyr::mutate(
    variable = sapfluxnetr:::.metadata_architecture() %>%
      magrittr::extract2(., 'site_md') %>%
      names()
  ) %>%
  select(variable, everything())
stand_md_table <- sapfluxnetr:::.metadata_architecture() %>%
  magrittr::extract2(., 'stand_md') %>%
  purrr::map_dfr(magrittr::extract, c('description', 'type', 'units')) %>%
  dplyr::mutate(
    variable = sapfluxnetr:::.metadata_architecture() %>%
      magrittr::extract2(., 'stand_md') %>%
      names()
  ) %>%
  select(variable, everything())
species_md_table <- sapfluxnetr:::.metadata_architecture() %>%
  magrittr::extract2(., 'species_md') %>%
  purrr::map_dfr(magrittr::extract, c('description', 'type', 'units')) %>%
  dplyr::mutate(
    variable = sapfluxnetr:::.metadata_architecture() %>%
      magrittr::extract2(., 'species_md') %>%
      names()
  ) %>%
  select(variable, everything())
plant_md_table <- sapfluxnetr:::.metadata_architecture() %>%
  magrittr::extract2(., 'plant_md') %>%
  purrr::map_dfr(magrittr::extract, c('description', 'type', 'units')) %>%
  dplyr::mutate(
    variable = sapfluxnetr:::.metadata_architecture() %>%
      magrittr::extract2(., 'plant_md') %>%
      names()
  ) %>%
  select(variable, everything())
env_md_table <- sapfluxnetr:::.metadata_architecture() %>%
  magrittr::extract2(., 'env_md') %>%
  purrr::map_dfr(magrittr::extract, c('description', 'type', 'units')) %>%
  dplyr::mutate(
    variable = sapfluxnetr:::.metadata_architecture() %>%
      magrittr::extract2(., 'env_md') %>%
      names()
  ) %>%
  select(variable, everything())
bind_rows(
  site_md_table, stand_md_table, species_md_table, plant_md_table, env_md_table
) %>% 
  qflextable() %>%
   bold( i = 1,  part = "header") %>%
   set_caption('Table X. Metadata variables list') %>% 
  width(width=c(1.8,2.25,1.2,1.2)) %>%
  height(height=.9)
```
\pagebreak

```{r fig_outliers_app, echo=FALSE,  out.height="800px",fig.align='center', fig.cap='Figure SX. Outliers app'}

knitr::include_graphics('resources/out_app.png')
```

\pagebreak

```{r tab_ntrees_species, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results="asis"}

sfn_species_ntrees %>% 
  select(species,n_trees) -> sfn_species_ntrees_reduced

data.frame(sfn_species_ntrees_reduced[1:58,],
          sfn_species_ntrees_reduced[59:116,],
           sfn_species_ntrees_reduced[117:174,])%>% 

  flextable::qflextable() %>% 
  flextable::autofit(add_w=0,add_h=0) %>%
  flextable::set_header_labels(
    species='species',
    n_trees= 'N trees',
    species.1='species',
    n_trees.1= 'N trees',
    species.2='species',
    n_trees.2= 'N trees') %>% 
  flextable::bold( i = 1,  part = "header") %>% 
  fontsize(size=10,part='body') %>% 
  flextable::set_caption('Table X. Number of trees per species')

```



\pagebreak
```{r tab_ntrees_genus, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results="asis"}

data.frame(sfn_genus_ntrees[1:32,],
          sfn_genus_ntrees[33:64,],
         add_row(sfn_genus_ntrees[65:95,],genus_f=NA,n_trees=''))%>% 
  qflextable() %>% 
  autofit(add_w=0,add_h=0) %>%
  set_header_labels(
    genus_f= 'Genus',
    n_trees = 'N trees',
    genus_f.1= 'Genus',
    n_trees.1 = 'N trees',
    genus_f.2= 'Genus',
    n_trees.2 = 'N trees') %>% 
   bold( i = 1,  part = "header") %>% 
  fontsize(size=10,part='body') %>% 
   set_caption('Table X. Number of trees per genus')

```
\pagebreak

```{r tab_nspecies_dataset, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, results="asis"}
data.frame(sfn_nspecies_dataset[1:58,],
           sfn_nspecies_dataset[59:116,],
           sfn_nspecies_dataset[117:174,])%>% 
  flextable::qflextable() %>% 
  flextable::autofit(add_w=0,add_h=0) %>%
  flextable::set_header_labels(
    sp_name='species',
    n_sites= 'N datasets',
    sp_name.1='species',
    n_sites.1= 'N datasets',
    sp_name.2='species',
    n_sites.2= 'N datasets') %>% 
  flextable::bold( i = 1,  part = "header") %>% 
  fontsize(size=10,part='body') %>% 
  flextable::set_caption('Table X. Number of datasets per species')

```
\pagebreak

